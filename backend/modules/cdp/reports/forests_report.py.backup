#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
CDP Forests Raporu
Orman ürünleri raporlaması için PDF/DOCX oluşturma
"""

import os
from datetime import datetime
from typing import Any, Dict, Optional

from docx import Document
from docx.enum.text import WD_ALIGN_PARAGRAPH
from docx.shared import Pt

from ..ai_analyzer import CDPAIAnalyzer
from ..cdp_data_collector import CDPDataCollector


def _add_turkish_paragraph(doc, text, style=None, font_name='Calibri', font_size=11):
    """Türkçe karakterleri destekleyen paragraf ekle"""
    para = doc.add_paragraph(text, style=style)
    for run in para.runs:
        run.font.name = font_name
        run.font.size = Pt(font_size)
    return para

def _add_turkish_heading(doc, text, level=1, font_name='Calibri'):
    """Türkçe karakterleri destekleyen başlık ekle"""
    heading = doc.add_heading(text, level=level)
    for run in heading.runs:
        run.font.name = font_name
    return heading


class ForestsReport:
    """CDP Forests Raporu oluşturucu"""
    
    def __init__(self, use_ai: bool = True, api_key: Optional[str] = None):
        self.collector = CDPDataCollector()
        self.analyzer = CDPAIAnalyzer(use_api=False if not api_key else True, api_key=api_key)
        self.use_ai = use_ai
    
    def generate_report(self, company_id: int, year: int, output_path: str) -> bool:
        """CDP Forests raporu oluştur"""
        try:
            print(f"[CDP Forests] Rapor oluşturuluyor: {year}")
            
            # Veri toplama
            data = self._collect_all_data(company_id, year)
            
            # AI Analiz
            if self.use_ai:
                analysis = self.analyzer.analyze_forests(data)
            else:
                analysis = {}
            
            # DOCX raporu
            doc = self._create_docx_report(data, analysis)
            doc.save(output_path)
            
            print(f"[CDP Forests] Rapor kaydedildi: {output_path}")
            return True
            
        except Exception as e:
            print(f"[HATA] CDP Forests raporu oluşturulamadı: {e}")
            import traceback
            traceback.print_exc()
            return False
    
    def _collect_all_data(self, company_id: int, year: int) -> Dict[str, Any]:
        """Tüm gerekli verileri topla"""
        data = {}
        data['company_info'] = self.collector.collect_company_info(company_id)
        forests_data = self.collector.collect_forests_data(company_id, year)
        data['cdp_responses'] = forests_data.get('cdp_responses', [])
        data['year'] = year
        return data
    
    def _create_docx_report(self, data: Dict, analysis: Dict) -> Document:
        """DOCX raporu oluştur"""
        doc = Document()
        
        # Başlık
        title = doc.add_heading('CDP FORESTS RAPORU', 0)
        title.alignment = WD_ALIGN_PARAGRAPH.CENTER
        
        company_name = data['company_info'].get('name', 'Şirket')
        year = data.get('year', datetime.now().year)
        
        subtitle = doc.add_paragraph(f'{company_name} - {year}')
        subtitle.alignment = WD_ALIGN_PARAGRAPH.CENTER
        subtitle.runs[0].font.size = Pt(14)
        
        doc.add_paragraph()
        
        # 1. Özet
        doc.add_heading('1. YÖNETİCİ ÖZETİ', 1)
        if analysis.get('summary'):
            doc.add_paragraph(analysis['summary'])
        else:
            doc.add_paragraph("Bu rapor, orman ürünleri kullanımı ve ormansızlaşma risklerini değerlendirmektedir.")
        
        # 2. Orman Ürünleri
        doc.add_page_break()
        doc.add_heading('2. ORMAN ÜRÜNLERİ KULLANIMI', 1)
        doc.add_paragraph("""
Şirketimiz, tedarik zincirinde aşağıdaki orman ürünlerini kullanmaktadır:
- Ahşap ve ahşap ürünleri
- Kağıt ve karton
- Palm yağı
- Sığır eti/deri
        """.strip())
        
        # 3. Riskler
        if analysis.get('risks'):
            doc.add_page_break()
            doc.add_heading('3. ORMANSIZLAŞMA RİSKLERİ', 1)
            doc.add_paragraph(analysis['risks'])
        
        # 4. Öneriler
        if analysis.get('recommendations'):
            doc.add_page_break()
            doc.add_heading('4. ÖNERİLER', 1)
            doc.add_paragraph(analysis['recommendations'])
        
        # Altbilgi
        doc.add_page_break()
        footer = doc.add_paragraph()
        footer.add_run(f'Rapor Tarihi: {datetime.now().strftime("%d.%m.%Y")}\n').font.size = Pt(9)
        footer.alignment = WD_ALIGN_PARAGRAPH.CENTER
        
        return doc

