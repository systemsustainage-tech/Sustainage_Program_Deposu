#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
TCFD REPORT GENERATOR - Rapor Oluşturma
- PDF, DOCX, Excel formatlarında TCFD raporu
- 4 temel bileşen: Governance, Strategy, Risk Management, Metrics
- Grafikler ve tablolar
- Finansal etki analizi
"""

import json
import os
from datetime import datetime
from typing import Dict, List, Optional

# Rapor oluşturma için gerekli kütüphaneler
try:
    from reportlab.lib import colors
    from reportlab.lib.enums import TA_CENTER, TA_JUSTIFY, TA_LEFT
    from reportlab.lib.pagesizes import A4, letter
    from reportlab.lib.styles import ParagraphStyle, getSampleStyleSheet
    from reportlab.lib.units import inch
    from reportlab.platypus import (PageBreak, Paragraph, SimpleDocTemplate,
                                    Spacer, Table, TableStyle)
    REPORTLAB_AVAILABLE = True
except ImportError:
    REPORTLAB_AVAILABLE = False
    print("[WARN] ReportLab not available. PDF generation disabled.")

try:
    from docx import Document
    from docx.enum.text import WD_ALIGN_PARAGRAPH
    from docx.shared import Inches, Pt, RGBColor
    DOCX_AVAILABLE = True
except ImportError:
    DOCX_AVAILABLE = False
    print("[WARN] python-docx not available. DOCX generation disabled.")

try:
    import openpyxl
    from openpyxl.styles import Alignment, Border, Font, PatternFill, Side
    EXCEL_AVAILABLE = True
except ImportError:
    EXCEL_AVAILABLE = False
    print("[WARN] openpyxl not available. Excel generation disabled.")


def _add_turkish_paragraph(doc, text, style=None, font_name='Calibri', font_size=11):
    """Türkçe karakterleri destekleyen paragraf ekle"""
    para = doc.add_paragraph(text, style=style)
    for run in para.runs:
        run.font.name = font_name
        run.font.size = Pt(font_size)
    return para

def _add_turkish_heading(doc, text, level=1, font_name='Calibri'):
    """Türkçe karakterleri destekleyen başlık ekle"""
    heading = doc.add_heading(text, level=level)
    for run in heading.runs:
        run.font.name = font_name
    return heading


class TCFDReportGenerator:
    """TCFD rapor oluşturucu"""
    
    def __init__(self, manager, calculator):
        """
        Args:
            manager: TCFDManager instance
            calculator: TCFDCalculator instance
        """
        self.manager = manager
        self.calculator = calculator
    
    # ========================================================================
    # PDF RAPOR
    # ========================================================================
    
    def generate_pdf_report(
        self,
        company_id: int,
        year: int,
        company_name: str,
        output_path: str
    ) -> bool:
        """
        PDF TCFD raporu oluştur
        
        Args:
            company_id: Firma ID
            year: Raporlama yılı
            company_name: Firma adı
            output_path: Çıktı dosya yolu
        
        Returns:
            Başarılı mı?
        """
        if not REPORTLAB_AVAILABLE:
            print("[ERROR] ReportLab not installed")
            return False
        
        try:
            # PDF document
            doc = SimpleDocTemplate(
                output_path,
                pagesize=A4,
                rightMargin=72,
                leftMargin=72,
                topMargin=72,
                bottomMargin=18
            )
            
            # Story (içerik)
            story = []
            styles = getSampleStyleSheet()
            
            # Custom styles - TÜRKÇE KARAKTER DESTEKLİ
            title_style = ParagraphStyle(
                'CustomTitle',
                parent=styles['Heading1'],
                fontSize=24,
                textColor=colors.HexColor('#2E8B57'),
                spaceAfter=30,
                alignment=TA_CENTER,
                fontName='DejaVuSans-Bold'  # Türkçe karakter desteği
            )
            
            heading_style = ParagraphStyle(
                'CustomHeading',
                parent=styles['Heading2'],
                fontSize=16,
                textColor=colors.HexColor('#2E8B57'),
                spaceAfter=12,
                spaceBefore=20,
                fontName='DejaVuSans-Bold'  # Türkçe karakter desteği
            )
            
            # Başlık sayfası
            story.append(Spacer(1, 2*inch))
            story.append(Paragraph(f"{company_name}", title_style))
            story.append(Spacer(1, 0.3*inch))
            story.append(Paragraph(
                "TCFD Raporu",
                ParagraphStyle('Subtitle', parent=styles['Normal'], 
                             fontSize=18, alignment=TA_CENTER, fontName='DejaVuSans-Bold')
            ))
            story.append(Paragraph(
                "Task Force on Climate-related Financial Disclosures",
                ParagraphStyle('Subtitle2', parent=styles['Normal'], 
                             fontSize=12, alignment=TA_CENTER, textColor=colors.grey, fontName='DejaVuSans')
            ))
            story.append(Spacer(1, 0.5*inch))
            story.append(Paragraph(
                f"Raporlama Yılı: {year}",
                ParagraphStyle('Year', parent=styles['Normal'], 
                             fontSize=14, alignment=TA_CENTER, textColor=colors.HexColor('#2E8B57'), fontName='DejaVuSans-Bold')
            ))
            story.append(Spacer(1, 0.3*inch))
            story.append(Paragraph(
                f"Rapor Tarihi: {datetime.now().strftime('%d %B %Y')}",
                ParagraphStyle('Date', parent=styles['Normal'], 
                             fontSize=10, alignment=TA_CENTER, textColor=colors.grey, fontName='DejaVuSans')
            ))
            
            story.append(PageBreak())
            
            # İçindekiler (basit)
            story.append(Paragraph("İçindekiler", heading_style))
            toc_data = [
                ["1.", "Yönetişim (Governance)", "3"],
                ["2.", "Strateji (Strategy)", "5"],
                ["3.", "Risk Yönetimi (Risk Management)", "8"],
                ["4.", "Metrikler ve Hedefler (Metrics and Targets)", "12"],
            ]
            
            toc_table = Table(toc_data, colWidths=[0.5*inch, 4*inch, 0.5*inch])
            toc_table.setStyle(TableStyle([
                ('FONT', (0, 0), (-1, -1), 'Helvetica', 11),
                ('BOTTOMPADDING', (0, 0), (-1, -1), 12),
            ]))
            story.append(toc_table)
            story.append(PageBreak())
            
            # 1. Governance
            story.append(Paragraph("1. Yönetişim (Governance)", heading_style))
            gov_data = self.manager.get_governance(company_id, year)
            
            if gov_data:
                story.append(Paragraph(
                    "<b>Yönetim Kurulu Gözetimi:</b>",
                    styles['Heading3']
                ))
                story.append(Paragraph(
                    gov_data.get('board_oversight', 'Veri yok'),
                    styles['BodyText']
                ))
                story.append(Spacer(1, 0.2*inch))
                
                story.append(Paragraph(
                    "<b>Üst Yönetimin Rolü:</b>",
                    styles['Heading3']
                ))
                story.append(Paragraph(
                    gov_data.get('management_role', 'Veri yok'),
                    styles['BodyText']
                ))
            else:
                story.append(Paragraph(
                    "Yönetişim verileri henüz girilmemiş.",
                    styles['BodyText']
                ))
            
            story.append(PageBreak())
            
            # 2. Strategy
            story.append(Paragraph("2. Strateji (Strategy)", heading_style))
            strategy_data = self.manager.get_strategy(company_id, year)
            
            if strategy_data:
                story.append(Paragraph(
                    "<b>Kısa Vadeli Riskler (0-3 yıl):</b>",
                    styles['Heading3']
                ))
                story.append(Paragraph(
                    strategy_data.get('short_term_risks', 'Veri yok'),
                    styles['BodyText']
                ))
                story.append(Spacer(1, 0.2*inch))
                
                story.append(Paragraph(
                    "<b>Fırsatlar:</b>",
                    styles['Heading3']
                ))
                story.append(Paragraph(
                    strategy_data.get('short_term_opportunities', 'Veri yok'),
                    styles['BodyText']
                ))
            else:
                story.append(Paragraph(
                    "Strateji verileri henüz girilmemiş.",
                    styles['BodyText']
                ))
            
            story.append(PageBreak())
            
            # 3. Risk Management
            story.append(Paragraph("3. Risk Yönetimi", heading_style))
            risks = self.manager.get_climate_risks(company_id, year)
            
            if risks:
                # Risk tablosu
                risk_table_data = [
                    ["Risk Adı", "Kategori", "Derece", "Finansal Etki"]
                ]
                
                for risk in risks[:10]:  # İlk 10 risk
                    risk_table_data.append([
                        risk['risk_name'][:40],
                        risk['risk_category'],
                        risk['risk_rating'],
                        f"${risk.get('financial_impact_high', 0):,.0f}" if risk.get('financial_impact_high') else "-"
                    ])
                
                risk_table = Table(risk_table_data, colWidths=[2.5*inch, 1.2*inch, 0.8*inch, 1*inch])
                risk_table.setStyle(TableStyle([
                    ('BACKGROUND', (0, 0), (-1, 0), colors.HexColor('#2E8B57')),
                    ('TEXTCOLOR', (0, 0), (-1, 0), colors.whitesmoke),
                    ('ALIGN', (0, 0), (-1, -1), 'LEFT'),
                    ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
                    ('FONTSIZE', (0, 0), (-1, 0), 10),
                    ('BOTTOMPADDING', (0, 0), (-1, 0), 12),
                    ('GRID', (0, 0), (-1, -1), 1, colors.grey),
                    ('ROWBACKGROUNDS', (0, 1), (-1, -1), [colors.white, colors.HexColor('#F5F5F5')])
                ]))
                story.append(risk_table)
            else:
                story.append(Paragraph(
                    "İklim riskleri henüz tanımlanmamış.",
                    styles['BodyText']
                ))
            
            story.append(PageBreak())
            
            # 4. Metrics
            story.append(Paragraph("4. Metrikler ve Hedefler", heading_style))
            story.append(Paragraph(
                "Metrik verileri henüz girilmemiş.",
                styles['BodyText']
            ))
            
            # PDF oluştur
            doc.build(story)
            
            print(f"[OK] PDF raporu oluşturuldu: {output_path}")
            return True
            
        except Exception as e:
            print(f"[ERROR] PDF raporu oluşturulamadı: {e}")
            import traceback
            traceback.print_exc()
            return False
    
    # ========================================================================
    # DOCX RAPOR
    # ========================================================================
    
    def generate_docx_report(
        self,
        company_id: int,
        year: int,
        company_name: str,
        output_path: str
    ) -> bool:
        """
        Word DOCX raporu oluştur
        
        Returns:
            Başarılı mı?
        """
        if not DOCX_AVAILABLE:
            print("[ERROR] python-docx not installed")
            return False
        
        try:
            doc = Document()
            
            # Başlık
            title = doc.add_heading(company_name, 0)
            title.alignment = WD_ALIGN_PARAGRAPH.CENTER
            
            subtitle = doc.add_paragraph("TCFD Raporu")
            subtitle.alignment = WD_ALIGN_PARAGRAPH.CENTER
            subtitle.runs[0].font.size = Pt(18)
            subtitle.runs[0].font.color.rgb = RGBColor(46, 139, 87)
            
            doc.add_paragraph(f"Raporlama Yılı: {year}").alignment = WD_ALIGN_PARAGRAPH.CENTER
            doc.add_paragraph(f"Rapor Tarihi: {datetime.now().strftime('%d %B %Y')}").alignment = WD_ALIGN_PARAGRAPH.CENTER
            
            doc.add_page_break()
            
            # 1. Governance
            doc.add_heading("1. Yönetişim (Governance)", 1)
            gov_data = self.manager.get_governance(company_id, year)
            
            if gov_data:
                doc.add_heading("Yönetim Kurulu Gözetimi", 2)
                doc.add_paragraph(gov_data.get('board_oversight', 'Veri yok'))
                
                doc.add_heading("Üst Yönetimin Rolü", 2)
                doc.add_paragraph(gov_data.get('management_role', 'Veri yok'))
            else:
                doc.add_paragraph("Yönetişim verileri henüz girilmemiş.")
            
            doc.add_page_break()
            
            # 2. Strategy
            doc.add_heading("2. Strateji (Strategy)", 1)
            strategy_data = self.manager.get_strategy(company_id, year)
            
            if strategy_data:
                doc.add_heading("Kısa Vadeli Riskler", 2)
                doc.add_paragraph(strategy_data.get('short_term_risks', 'Veri yok'))
                
                doc.add_heading("Fırsatlar", 2)
                doc.add_paragraph(strategy_data.get('short_term_opportunities', 'Veri yok'))
            else:
                doc.add_paragraph("Strateji verileri henüz girilmemiş.")
            
            doc.add_page_break()
            
            # 3. Risk Management
            doc.add_heading("3. Risk Yönetimi", 1)
            risks = self.manager.get_climate_risks(company_id, year)
            
            if risks:
                # Risk tablosu
                table = doc.add_table(rows=1, cols=4)
                table.style = 'Light Grid Accent 1'
                
                # Başlıklar
                hdr_cells = table.rows[0].cells
                hdr_cells[0].text = 'Risk Adı'
                hdr_cells[1].text = 'Kategori'
                hdr_cells[2].text = 'Derece'
                hdr_cells[3].text = 'Finansal Etki'
                
                # Riskler
                for risk in risks[:20]:
                    row_cells = table.add_row().cells
                    row_cells[0].text = risk['risk_name']
                    row_cells[1].text = risk['risk_category']
                    row_cells[2].text = risk['risk_rating']
                    row_cells[3].text = f"${risk.get('financial_impact_high', 0):,.0f}" if risk.get('financial_impact_high') else "-"
            else:
                doc.add_paragraph("İklim riskleri henüz tanımlanmamış.")
            
            doc.add_page_break()
            
            # 4. Metrics
            doc.add_heading("4. Metrikler ve Hedefler", 1)
            doc.add_paragraph("Metrik verileri henüz girilmemiş.")
            
            # Kaydet
            doc.save(output_path)
            
            print(f"[OK] DOCX raporu oluşturuldu: {output_path}")
            return True
            
        except Exception as e:
            print(f"[ERROR] DOCX raporu oluşturulamadı: {e}")
            import traceback
            traceback.print_exc()
            return False
    
    # ========================================================================
    # EXCEL RAPOR
    # ========================================================================
    
    def generate_excel_report(
        self,
        company_id: int,
        year: int,
        company_name: str,
        output_path: str
    ) -> bool:
        """
        Excel raporu oluştur (veri tabloları)
        
        Returns:
            Başarılı mı?
        """
        if not EXCEL_AVAILABLE:
            print("[ERROR] openpyxl not installed")
            return False
        
        try:
            wb = openpyxl.Workbook()
            
            # Sheet 1: Overview
            ws1 = wb.active
            ws1.title = "Overview"
            ws1['A1'] = "TCFD Raporu"
            ws1['A1'].font = Font(size=18, bold=True, color="2E8B57")
            ws1['A2'] = company_name
            ws1['A3'] = f"Yıl: {year}"
            ws1['A4'] = f"Tarih: {datetime.now().strftime('%d/%m/%Y')}"
            
            # Sheet 2: Governance
            ws2 = wb.create_sheet("Governance")
            gov_data = self.manager.get_governance(company_id, year)
            
            if gov_data:
                ws2['A1'] = "Yönetişim Verileri"
                ws2['A1'].font = Font(bold=True, size=14)
                
                row = 3
                for key, value in gov_data.items():
                    if key not in ['id', 'company_id', 'reporting_year', 'created_at', 'updated_at', 'created_by']:
                        ws2[f'A{row}'] = key.replace('_', ' ').title()
                        ws2[f'B{row}'] = str(value) if value else ""
                        row += 1
            
            # Sheet 3: Risks
            ws3 = wb.create_sheet("Climate Risks")
            risks = self.manager.get_climate_risks(company_id, year)
            
            # Başlıklar
            headers = ["Risk Adı", "Kategori", "Tip", "Olasılık", "Etki", "Derece", 
                      "Zaman Ufku", "Finansal Etki (Min)", "Finansal Etki (Maks)", "Durum"]
            for col, header in enumerate(headers, 1):
                cell = ws3.cell(row=1, column=col, value=header)
                cell.font = Font(bold=True)
                cell.fill = PatternFill(start_color="2E8B57", end_color="2E8B57", fill_type="solid")
                cell.font = Font(color="FFFFFF", bold=True)
            
            # Riskler
            for row, risk in enumerate(risks, 2):
                ws3.cell(row=row, column=1, value=risk['risk_name'])
                ws3.cell(row=row, column=2, value=risk['risk_category'])
                ws3.cell(row=row, column=3, value=risk['risk_type'])
                ws3.cell(row=row, column=4, value=risk.get('likelihood', ''))
                ws3.cell(row=row, column=5, value=risk.get('impact', ''))
                ws3.cell(row=row, column=6, value=risk['risk_rating'])
                ws3.cell(row=row, column=7, value=risk.get('time_horizon', ''))
                ws3.cell(row=row, column=8, value=risk.get('financial_impact_low', ''))
                ws3.cell(row=row, column=9, value=risk.get('financial_impact_high', ''))
                ws3.cell(row=row, column=10, value=risk.get('status', ''))
            
            # Sütun genişlikleri
            for col in range(1, 11):
                ws3.column_dimensions[openpyxl.utils.get_column_letter(col)].width = 15
            
            # Kaydet
            wb.save(output_path)
            
            print(f"[OK] Excel raporu oluşturuldu: {output_path}")
            return True
            
        except Exception as e:
            print(f"[ERROR] Excel raporu oluşturulamadı: {e}")
            import traceback
            traceback.print_exc()
            return False


# Test
if __name__ == "__main__":
    print(" TCFD Report Generator Test")
    print("="*60)
    
    # Test için manager gerekli
    from tcfd_calculator import TCFDCalculator
    from tcfd_manager import TCFDManager
    
    db_path = "../../data/sdg_desktop.sqlite"
    
    if os.path.exists(db_path):
        manager = TCFDManager(db_path)
        calculator = TCFDCalculator()
        generator = TCFDReportGenerator(manager, calculator)
        
        print("\n Report Generator başlatıldı")
        print(f"   PDF: {REPORTLAB_AVAILABLE}")
        print(f"   DOCX: {DOCX_AVAILABLE}")
        print(f"   Excel: {EXCEL_AVAILABLE}")
    else:
        print(" Veritabanı bulunamadı")
    
    print("="*60)

