{% extends "base.html" %}

{% block title %}Yedekleme ve Geri Yükleme{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const restoreButtons = document.querySelectorAll('.btn-confirm-restore');
        restoreButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                const msg = this.getAttribute('data-confirm-message');
                if (!confirm(msg)) {
                    e.preventDefault();
                }
            });
        });
    });
</script>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
<div>
<h1 class="h2">Yedekleme ve Geri Yükleme</h1>
<p class="text-muted mb-0">
            Veritabanı ve dosyalar için manuel yedek alma, geri yükleme ve otomatik yedek ayarları.
        </p>
</div>
<div class="btn-toolbar mb-2 mb-md-0">

<button class="btn btn-sm btn-outline-secondary ms-2" onclick="history.back()"><i class="bi bi-arrow-left"></i> {{ lang('btn_back', 'Geri') }}</button></div>
</div>
<div class="row g-4 mb-4">
<div class="col-md-3">
<div class="card border-0 shadow-sm">
<div class="card-body">
<h6 class="text-muted text-uppercase">Toplam Yedek</h6>
<h2 class="fw-bold mb-0">{{ stats.total_backups or 0 }}</h2>
</div>
</div>
</div>
<div class="col-md-3">
<div class="card border-0 shadow-sm">
<div class="card-body">
<h6 class="text-muted text-uppercase">Başarılı</h6>
<h2 class="fw-bold mb-0 text-success">{{ stats.successful_backups or 0 }}</h2>
</div>
</div>
</div>
<div class="col-md-3">
<div class="card border-0 shadow-sm">
<div class="card-body">
<h6 class="text-muted text-uppercase">Başarısız</h6>
<h2 class="fw-bold mb-0 text-danger">{{ stats.failed_backups or 0 }}</h2>
</div>
</div>
</div>
<div class="col-md-3">
<div class="card border-0 shadow-sm">
<div class="card-body">
<h6 class="text-muted text-uppercase">Toplam Boyut (MB)</h6>
<h2 class="fw-bold mb-0">{{ stats.total_size_mb or 0 }}</h2>
</div>
</div>
</div>
</div>
<div class="row g-4 mb-4">
<div class="col-lg-6">
<div class="card border-0 shadow-sm mb-4">
<div class="card-header">
<h5 class="mb-0">Manuel Yedekleme</h5>
</div>
<div class="card-body">
<form method="post">
<input name="action" type="hidden" value="create"/>
<div class="mb-3">
<label class="form-label">Yedekleme Tipi</label>
<select class="form-select" name="backup_type">
<option value="full">Tam yedek (veritabanı + dosyalar)</option>
<option value="database_only">Sadece veritabanı</option>
<option value="files_only">Sadece dosyalar</option>
</select>
</div>
<button class="btn btn-primary" type="submit">
<i class="bi bi-hdd"></i> Yedek Oluştur
                    </button>
</form>
</div>
</div>
<div class="card border-0 shadow-sm">
<div class="card-header">
<h5 class="mb-0">Otomatik Yedekleme Ayarları</h5>
</div>
<div class="card-body">
<form class="row g-3" method="post">
<input name="action" type="hidden" value="save_config"/>
<div class="col-12">
<div class="form-check form-switch">
<input class="form-check-input" id="auto_backup_enabled" name="auto_backup_enabled" role="switch" type="checkbox" value="1" {% if config.auto_backup_enabled %}checked{% endif %}/>
<label class="form-check-label" for="auto_backup_enabled">Otomatik yedekleme aktif</label>
</div>
</div>
<div class="col-md-6">
<label class="form-label">Sıklık</label>
<select class="form-select" name="backup_frequency">
<option value="daily" {% if config.backup_frequency == 'daily' %}selected{% endif %}>Günlük</option>
<option value="weekly" {% if config.backup_frequency == 'weekly' %}selected{% endif %}>Haftalık</option>
<option value="monthly" {% if config.backup_frequency == 'monthly' %}selected{% endif %}>Aylık</option>
</select>
</div>
<div class="col-md-6">
<label class="form-label">Saat</label>
<input class="form-control" name="backup_time" type="time" value="{{ config.backup_time or '02:00' }}"/>
</div>
<div class="col-md-6">
<label class="form-label">Maksimum Yedek Sayısı</label>
<input class="form-control" min="1" name="max_backups" type="number" value="{{ config.max_backups or 30 }}"/>
</div>
<div class="col-12">
<button class="btn btn-success" type="submit">
<i class="bi bi-save"></i> Ayarları Kaydet
                        </button>
</div>
</form>
</div>
</div>
</div>
<div class="col-lg-6">
<div class="card border-0 shadow-sm">
<div class="card-header d-flex justify-content-between align-items-center">
<h5 class="mb-0">Son Yedekler</h5>
<small class="text-muted">Gösterilen: {{ backups|length }}</small>
</div>
<div class="card-body p-0">
<div class="table-responsive">
<table class="table table-striped table-hover mb-0">
<thead class="table-light">
<tr>
<th>ID</th>
<th>Ad</th>
<th>Tip</th>
<th>Boyut (MB)</th>
<th>Tarih</th>
<th>Durum</th>
<th>İşlemler</th>
</tr>
</thead>
<tbody>
                            {% for b in backups %}
                            <tr>
<td>{{ b.id }}</td>
<td>{{ b.name }}</td>
<td>{{ b.type }}</td>
<td>{{ (b.size or 0) / (1024 * 1024) | round(2) }}</td>
<td>{{ b.date }}</td>
<td>
                                    {% if b.status == 'completed' %}
                                    <span class="badge bg-success">Tamamlandı</span>
                                    {% else %}
                                    <span class="badge bg-danger">Hata</span>
                                    {% endif %}
                                </td>
<td>
<div class="d-flex gap-2">
<form class="d-inline" method="post">
<input name="action" type="hidden" value="restore"/>
<input name="backup_id" type="hidden" value="{{ b.id }}"/>
<button class="btn btn-sm btn-outline-warning btn-confirm-restore" data-confirm-message="Seçili yedeği geri yüklemek istediğinize emin misiniz? İşlem geri alınamaz." type="submit">
                                                Geri Yükle
                                            </button>
</form>
<a class="btn btn-sm btn-outline-secondary" href="{{ url_for('super_admin_backup_download', backup_id=b.id) }}">
                                            İndir
                                        </a>
</div>
</td>
</tr>
                            {% else %}
                            <tr>
<td class="text-center py-3 text-muted" colspan="7">
                                    Henüz yedek bulunmuyor.
                                </td>
</tr>
                            {% endfor %}
                        </tbody>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="card border-0 shadow-sm mt-4">
<div class="card-header">
<h5 class="mb-0">Son Yedek Özeti</h5>
</div>
<div class="card-body">
<div class="row">
<div class="col-md-6">
<p class="mb-1"><strong>Son Yedek Adı:</strong> {{ stats.last_backup_name or 'N/A' }}</p>
<p class="mb-0"><strong>Son Yedek Tarihi:</strong> {{ stats.last_backup_date or 'N/A' }}</p>
</div>
</div>
</div>
</div>

{% endblock %}

