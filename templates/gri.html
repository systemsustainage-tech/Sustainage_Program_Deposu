{% extends "base.html" %}

{% block title %}{{ lang('gri_title') }} - SDG Platform{% endblock %}

{% block content %}

<div class="row mb-4">
<div class="col-md-12">
<div class="d-flex justify-content-between align-items-center">
<h1><i class="fas fa-file-alt me-2"></i>{{ lang('gri_title') }}</h1>
<div>
<span class="badge bg-{{ 'success' if manager_available else 'danger' }}">
                    {{ lang('module_active_badge') if manager_available else lang('module_passive_badge') }}
                </span>
<button class="btn btn-sm btn-outline-secondary ms-2" onclick="history.back()"><i class="bi bi-arrow-left"></i> {{ lang('btn_back', 'Geri') }}</button></div>
</div>
<p class="lead text-muted">{{ lang('gri_desc') }}</p>
</div>
</div>

{% if manager_available %}
<div class="row mb-4">
<div class="col-md-12">
<div class="card">
<div class="card-body d-flex justify-content-between align-items-center">
<div>
<h5 class="card-title">{{ lang('gri_data_entry_title') }}</h5>
<p class="card-text mb-0">{{ lang('gri_data_entry_desc') }}</p>
</div>
<button class="btn btn-primary" data-bs-target="#addGriModal" data-bs-toggle="modal" type="button">
<i class="fas fa-plus me-1"></i> {{ lang('btn_add_data') }}
                </button>
</div>
</div>
</div>
</div>
<div class="row mb-4">
<div class="col-md-4">
<div class="card text-center h-100 border-primary">
<div class="card-body">
<h6 class="text-muted">{{ lang('gri_completed_disclosures') }}</h6>
<h2 class="display-4 text-primary">{{ stats.total_disclosures }}</h2>
</div>
</div>
</div>
<div class="col-md-4">
<div class="card text-center h-100 border-success">
<div class="card-body">
<h6 class="text-muted">{{ lang('gri_covered_standards') }}</h6>
<h2 class="display-4 text-success">{{ stats.standards_covered }}</h2>
</div>
</div>
</div>
<div class="col-md-4">
<div class="card text-center h-100 border-info">
<div class="card-body">
<h6 class="text-muted">{{ lang('gri_completion_rate') }}</h6>
<h2 class="display-4 text-info">%{{ stats.completion_rate }}</h2>
<div class="progress mt-2" style="height: 5px;">
<div class="progress-bar bg-info" role="progressbar" style="width: 0%" data-width="{{ stats.completion_rate }}"></div>
</div>
</div>
</div>
</div>
</div>
<div class="row mb-4">
<div class="col-md-12">
<div class="card">
<div class="card-header d-flex justify-content-between align-items-center">
<h5 class="mb-0">{{ lang('gri_standards_list') }}</h5>
<div class="col-md-3">
    <select class="form-select form-select-sm" id="sectorFilter" onchange="filterTable()">
        <option value="all">{{ lang('gri_all_sectors') }}</option>
        <option value="General">{{ lang('gri_sector_general', 'General') }}</option>
        <option value="Oil & Gas">{{ lang('gri_sector_oil_gas', 'Oil & Gas') }}</option>
        <option value="Coal">{{ lang('gri_sector_coal', 'Coal') }}</option>
        <option value="Mining">{{ lang('gri_sector_mining', 'Mining') }}</option>
        <option value="Agriculture">{{ lang('gri_sector_agriculture', 'Agriculture') }}</option>
        <option value="Energy">{{ lang('gri_sector_energy', 'Energy') }}</option>
    </select>
</div>
</div>
<div class="card-body">
<div class="table-responsive">
<table class="table table-hover" id="griTable">
<thead>
<tr>
<th>{{ lang('gri_year') }}</th>
<th>{{ lang('gri_standard') }}</th>
<th>{{ lang('sector', 'Sektör') }}</th>
<th>{{ lang('gri_disclosure') }}</th>
<th>{{ lang('gri_value') }}</th>
<th>{{ lang('gri_last_update') }}</th>
</tr>
</thead>
<tbody>
                            {% if standards %}
                                {% for item in standards %}
                                <tr data-sector="{{ item.sector }}">
<td>{{ item.year }}</td>
<td>
    <span class="badge bg-secondary">{{ item.standard }}</span>
    <small class="d-block text-muted">{{ item.standard_title }}</small>
</td>
<td><span class="badge bg-info text-dark">{{ item.sector }}</span></td>
<td><strong>{{ item.disclosure }}</strong></td>
<td>{{ item.value }}</td>
<td>{{ item.created_at[:10] }}</td>
</tr>
                                {% endfor %}
                            {% else %}
                                <tr>
<td class="text-center py-4 text-muted" colspan="6">
<i class="fas fa-info-circle me-1"></i> {{ lang('no_data_found') }}
                                    </td>
</tr>
                            {% endif %}
                        </tbody>
</table>
</div>
</div>
</div>
</div>
</div>

<script>
function filterTable() {
    var input, filter, table, tr, td, i, txtValue;
    input = document.getElementById("sectorFilter");
    filter = input.value;
    table = document.getElementById("griTable");
    tr = table.getElementsByTagName("tr");

    for (i = 0; i < tr.length; i++) {
        var sector = tr[i].getAttribute('data-sector');
        if (sector) {
            if (filter === 'all' || sector === filter) {
                tr[i].style.display = "";
            } else {
                tr[i].style.display = "none";
            }
        }
    }
}

function loadIndicators(standardCode) {
    var select = document.getElementById("disclosureSelect");
    select.innerHTML = '<option value="" disabled selected>Yükleniyor...</option>';
    
    fetch('/api/gri/indicators/' + encodeURIComponent(standardCode))
        .then(response => response.json())
        .then(data => {
            select.innerHTML = '<option value="" disabled selected>{{ lang("select_disclosure", "Gösterge Seçiniz") }}</option>';
            if (data.indicators && data.indicators.length > 0) {
                data.indicators.forEach(ind => {
                    var option = document.createElement("option");
                    option.value = ind.code;
                    option.text = ind.code + ' - ' + ind.title + ' (' + ind.unit + ')';
                    select.appendChild(option);
                });
            } else {
                var option = document.createElement("option");
                option.text = "Gösterge bulunamadı";
                option.disabled = true;
                select.appendChild(option);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            select.innerHTML = '<option value="" disabled selected>Hata oluştu</option>';
        });
}
</script>
<!-- Add GRI Modal -->
<div aria-hidden="true" class="modal fade" id="addGriModal" tabindex="-1">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title">{{ lang('gri_add_data', 'GRI Verisi Ekle') }}</h5>
<button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
</div>
<form action="{{ url_for('gri_add') }}" method="POST">
<div class="modal-body">
<div class="mb-3">
<label class="form-label" for="year">{{ lang('year', 'Yıl') }}</label>
<input class="form-control" name="year" required="" type="number" value="2025"/>
</div>
<div class="mb-3">
<label class="form-label" for="standard">{{ lang('gri_standard', 'Standart') }}</label>
<select class="form-select" name="standard" id="standardSelect" required onchange="loadIndicators(this.value)">
<option value="" selected disabled>{{ lang('select_standard', 'Standart Seçiniz') }}</option>
{% for group in all_standards|sort(attribute='sector')|groupby('sector') %}
    <optgroup label="{{ group.grouper }}">
        {% for s in group.list %}
            <option value="{{ s.code }}">{{ s.code }} - {{ s.title }}</option>
        {% endfor %}
    </optgroup>
{% endfor %}
</select>
</div>
<div class="mb-3">
<label class="form-label" for="disclosure">{{ lang('gri_disclosure', 'Gösterge') }}</label>
<select class="form-select" name="disclosure" id="disclosureSelect" required>
    <option value="" selected disabled>{{ lang('select_disclosure', 'Gösterge Seçiniz') }}</option>
</select>
</div>
<div class="mb-3">
<label class="form-label" for="value">{{ lang('value', 'Değer') }}</label>
<textarea class="form-control" name="value" required="" rows="3"></textarea>
</div>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" data-bs-dismiss="modal" type="button">{{ lang('cancel', 'İptal') }}</button>
<button class="btn btn-primary" type="submit">{{ lang('save', 'Kaydet') }}</button>
</div>
</form>
</div>
</div>
</div>

{% else %}
<div class="alert alert-warning">
<i class="bi bi-exclamation-triangle-fill"></i> {{ lang('manager_failed') }}
</div>
{% endif %}
{% endblock %}
