{% extends "base.html" %}

{% block title %}{{ lang('sdg_title') }} - SDG Platform{% endblock %}

{% block content %}

<style>
    .goal-card {
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
        border: 1px solid #dee2e6;
    }
    .goal-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .goal-card.selected {
        border-color: #28a745;
        background-color: #f0fff4;
    }
    .goal-list {
        max-height: 600px;
        overflow-y: auto;
        padding: 10px;
        background-color: #f8f9fa;
        border-radius: 5px;
        border: 1px solid #e9ecef;
    }
    .goal-img {
        width: 60px;
        height: 60px;
        object-fit: contain;
    }
    .goal-item {
        display: flex;
        align-items: center;
        background: white;
        margin-bottom: 10px;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #dee2e6;
    }
    .goal-item:hover {
        background-color: #f8f9fa;
    }
    .panel-title {
        font-weight: bold;
        color: #495057;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #e9ecef;
    }
</style>
<div class="container-fluid">
<div class="row mb-4">
<div class="col-12">
<div class="d-flex justify-content-between align-items-center">
<div>
<h1 class="h3 mb-0 text-gray-800"><i class="fas fa-globe-americas me-2"></i>{{ lang('sdg_title') }}</h1>
<p class="text-muted small mb-0">{{ lang('sdg_desc') }}</p>
</div>
<div>
<span class="badge bg-{{ 'success' if manager_available else 'danger' }}">
                        {{ lang('module_active_badge') if manager_available else _('module_passive_badge') }}
                    </span>
<button class="btn btn-sm btn-outline-secondary ms-2" onclick="history.back()"><i class="bi bi-arrow-left"></i> {{ lang('btn_back', 'Geri') }}</button></div>
</div>
</div>
</div>
<!-- Stats Cards -->
<div class="row mb-4">
<div class="col-md-4">
<div class="card border-left-primary shadow h-100 py-2">
<div class="card-body">
<div class="row no-gutters align-items-center">
<div class="col mr-2">
<div class="text-xs font-weight-bold text-primary text-uppercase mb-1">{{ lang('sdg_total_goals') }}</div>
<div class="h5 mb-0 font-weight-bold text-gray-800">{{ stats.total_goals }}</div>
</div>
<div class="col-auto">
<i class="fas fa-bullseye fa-2x text-gray-300"></i>
</div>
</div>
</div>
</div>
</div>
<div class="col-md-4">
<div class="card border-left-success shadow h-100 py-2">
<div class="card-body">
<div class="row no-gutters align-items-center">
<div class="col mr-2">
<div class="text-xs font-weight-bold text-success text-uppercase mb-1">{{ lang('sdg_completed_actions') }}</div>
<div class="h5 mb-0 font-weight-bold text-gray-800">{{ stats.completed_actions }}</div>
</div>
<div class="col-auto">
<i class="fas fa-check-circle fa-2x text-gray-300"></i>
</div>
</div>
</div>
</div>
</div>
<div class="col-md-4">
<div class="card border-left-info shadow h-100 py-2">
<div class="card-body">
<div class="row no-gutters align-items-center">
<div class="col mr-2">
<div class="text-xs font-weight-bold text-info text-uppercase mb-1">{{ lang('sdg_avg_progress') }}</div>
<div class="row no-gutters align-items-center">
<div class="col-auto">
<div class="h5 mb-0 mr-3 font-weight-bold text-gray-800">%{{ stats.avg_progress }}</div>
</div>
<div class="col">
<div class="progress progress-sm mr-2">
<div class="progress-bar bg-info" role="progressbar" style="width: {{ stats.avg_progress }}%"></div>
</div>
</div>
</div>
</div>
<div class="col-auto">
<i class="fas fa-clipboard-list fa-2x text-gray-300"></i>
</div>
</div>
</div>
</div>
</div>
</div>
<!-- Goal Selection Area -->
<div class="row mb-4">
<div class="col-12">
<div class="card shadow">
<div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
<h6 class="m-0 font-weight-bold text-primary">{{ lang('sdg_goal_selection') }}</h6>
<form action="{{ url_for('sdg_module') }}" id="sdgForm" method="POST">
<input name="save_selections" type="hidden" value="1"/>
<div id="hiddenInputs">
                            {% for goal_id in selected_ids %}
                            <input id="input_goal_{{ goal_id }}" name="selected_goals" type="hidden" value="{{ goal_id }}"/>
                            {% endfor %}
                        </div>
<button class="btn btn-primary btn-sm" type="submit">
<i class="fas fa-save me-1"></i> {{ lang('sdg_save_selections', 'Seçimleri Kaydet') }}
                        </button>
</form>
</div>
<div class="card-body">
<div class="row">
<!-- Left Panel: Available Goals -->
<div class="col-md-6">
<h5 class="panel-title text-center"><i class="fas fa-list me-2"></i>{{ lang('sdg_available_goals') }}</h5>
<div class="goal-list" id="availableGoalsList">
                                {% for goal in all_goals %}
                                    {% if goal.id not in selected_ids %}
                                    <div class="goal-item goal-card" data-id="{{ goal.id }}" data-title="{{ goal.title }}" id="goal_item_{{ goal.id }}" onclick="moveGoal({{ goal.id }}, 'available', 'selected')">
<img alt="{{ goal.title }}" class="goal-img me-3 rounded" src="{{ url_for('static', filename='images/' ~ goal.id ~ '.png') }}"/>
<div>
<h6 class="mb-0 font-weight-bold">{{ goal.id }}. {{ goal.title }}</h6>
</div>
<div class="ms-auto">
<i class="fas fa-arrow-right text-primary"></i>
</div>
</div>
                                    {% endif %}
                                {% endfor %}
                            </div>
</div>
<!-- Right Panel: Selected Goals -->
<div class="col-md-6">
<h5 class="panel-title text-center text-success"><i class="fas fa-check-square me-2"></i>{{ lang('sdg_selected_goals') }}</h5>
<div class="goal-list" id="selectedGoalsList">
                                {% for goal in all_goals %}
                                    {% if goal.id in selected_ids %}
                                    <div class="goal-item goal-card selected" data-id="{{ goal.id }}" data-title="{{ goal.title }}" id="goal_item_{{ goal.id }}" onclick="moveGoal('{{ goal.id }}', 'selected', 'available')">
<img alt="{{ goal.title }}" class="goal-img me-3 rounded" src="{{ url_for('static', filename='images/' ~ goal.id ~ '.png') }}"/>
<div>
<h6 class="mb-0 font-weight-bold">{{ goal.id }}. {{ goal.title }}</h6>
</div>
<div class="ms-auto">
<i class="fas fa-times text-danger"></i>
</div>
</div>
                                    {% endif %}
                                {% endfor %}
                            </div>
</div>
</div>
</div>
</div>
</div>
</div>
<!-- Selected Goals Details (Accordion) -->
    {% if selected_goals_details %}
    <div class="row">
<div class="col-12">
<div class="card shadow mb-4">
<div class="card-header py-3">
<h6 class="m-0 font-weight-bold text-primary">SDG Detayları</h6>
</div>
<div class="card-body">
<div class="accordion" id="sdgAccordion">
                        {% for detail in selected_goals_details %}
                        <div class="accordion-item">
<h2 class="accordion-header" id="heading{{ detail.id }}">
<button class="accordion-button {{ 'collapsed' if not loop.first else '' }}" data-bs-target="#collapse{{ detail.id }}" data-bs-toggle="collapse" type="button">
<div class="d-flex align-items-center w-100">
<img class="me-3" src="{{ url_for('static', filename='images/' ~ detail.id ~ '.png') }}" style="width: 30px; height: 30px;"/>
<span class="fw-bold">{{ detail.id }}. {{ detail.title }}</span>
</div>
</button>
</h2>
<div class="accordion-collapse collapse {{ 'show' if loop.first else '' }}" data-bs-parent="#sdgAccordion" id="collapse{{ detail.id }}">
<div class="accordion-body">
<p class="text-muted">{{ detail.description }}</p>
                                    
                                    {% if detail.module_link %}
                                    <div class="alert alert-info d-flex align-items-center justify-content-between">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-link me-3 fs-4"></i>
                                            <div>
                                                <strong>{{ lang('related_module') }}:</strong>
                                                <span class="ms-1">{{ detail.module_link.name }}</span>
                                            </div>
                                        </div>
                                        <a class="btn btn-primary btn-sm" href="{{ detail.module_link.url }}">
                                            <i class="fas fa-external-link-alt me-1"></i> Modüle Git
                                        </a>
                                    </div>
                                    {% endif %}

                                    <div class="table-responsive">
<table class="table table-sm table-hover">
<thead>
<tr>
<th>Hedef</th>
<th>Göstergeler</th>
<th>GRI Referansı</th>
</tr>
</thead>
<tbody>
                                                {% for target in detail.targets %}
                                                <tr>
<td style="width: 30%;">
<strong>{{ target.code }}</strong><br/>
<small>{{ target.title }}</small>
</td>
<td>
                                                        {% for ind in target.indicators %}
                                                        <div class="mb-2 d-flex justify-content-between align-items-center">
<div>
<span class="badge bg-secondary">{{ ind.code }}</span> {{ ind.title }}
                                                                {% if ind.unit %}
                                                                <small class="text-muted ms-1">({{ ind.unit }})</small>
                                                                {% endif %}
                                                            </div>
<button class="btn btn-sm btn-outline-primary ms-2" data-bs-target="#addSDGDataModal" data-bs-toggle="modal" data-code="{{ ind.code }}" data-indicator-id="{{ ind.id }}" data-title="{{ ind.title }}" data-unit="{{ ind.unit or '' }}" type="button">
<i class="fas fa-plus"></i>
</button>
</div>
                                                        {% endfor %}
                                                    </td>
<td>
                                                        {% for ind in target.indicators %}
                                                            {% for gri in ind.gri_mappings %}
                                                            <span class="badge bg-info text-dark">{{ gri.code }} ({{ gri.type }})</span>
                                                            {% endfor %}
                                                        {% endfor %}
                                                    </td>
</tr>
                                                {% endfor %}
                                            </tbody>
</table>
</div>
</div>
</div>
</div>
                        {% endfor %}
                    </div>
</div>
</div>
</div>
</div>
    {% endif %}

    <!-- Recent Actions Table -->
<div class="row">
<div class="col-12">
<div class="card shadow mb-4">
<div class="card-header py-3">
<h6 class="m-0 font-weight-bold text-primary">{{ lang('recent_data') }}</h6>
</div>
<div class="card-body">
<div class="table-responsive">
<table cellspacing="0" class="table table-bordered" width="100%" id="dataTable">
<thead>
<tr>
<th>Tarih</th>
<th>Gösterge</th>
<th>Değer</th>
<th>Aksiyon</th>
</tr>
</thead>
<tbody>
                            {% for item in recent_data %}
                            <tr>
<td>{{ item.created_at[:10] }}</td>
<td>{{ item.indicator_name }}</td>
<td><span class="badge bg-primary">{{ item.value }}</span></td>
<td>{{ item.action }}</td>
</tr>
                            {% endfor %}
                        </tbody>
</table>
</div>
</div>
</div>
</div>
</div>
<!-- Add SDG Data Modal -->
<div aria-hidden="true" aria-labelledby="addSDGDataModalLabel" class="modal fade" id="addSDGDataModal" tabindex="-1">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title" id="addSDGDataModalLabel">{{ lang('btn_add_data') }}</h5>
<button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
</div>
<form action="{{ url_for('sdg_add') }}" method="POST">
<div class="modal-body">
<input id="modal_indicator_id" name="indicator_id" type="hidden"/>
<div class="alert alert-info py-2 mb-3">
<i class="fas fa-info-circle me-2"></i>
<span class="fw-bold" id="modal_indicator_display"></span>
</div>
<div class="mb-3">
<label class="form-label" for="year">{{ lang('year') }}</label>
<input class="form-control" id="year" name="year" required="" type="number" value="2025"/>
</div>
<div class="mb-3">
<label class="form-label" for="value">{{ lang('value') }} <span class="text-muted small" id="modal_unit_display"></span></label>
<input class="form-control" id="value" name="value" required="" step="0.01" type="number"/>
</div>
<div class="mb-3">
<label class="form-label" for="progress_pct">{{ lang('progress_pct') }} (0-100)</label>
<input class="form-control" id="progress_pct" max="100" min="0" name="progress_pct" type="number"/>
</div>
<div class="mb-3">
<label class="form-label" for="status">{{ lang('status_label') }}</label>
<select class="form-select" id="status" name="status">
<option value="Başlanmadı">Başlanmadı</option>
<option value="Devam Ediyor">Devam Ediyor</option>
<option value="Tamamlandı">Tamamlandı</option>
</select>
</div>
<div class="mb-3">
<label class="form-label" for="action">{{ lang('description') }} / Aksiyon</label>
<textarea class="form-control" id="action" name="action" rows="3"></textarea>
</div>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" data-bs-dismiss="modal" type="button">{{ lang('cancel') }}</button>
<button class="btn btn-primary" type="submit">{{ lang('save') }}</button>
</div>
</form>
</div>
</div>
</div>
<script>
        document.addEventListener('DOMContentLoaded', function() {
            var addSDGDataModal = document.getElementById('addSDGDataModal');
            addSDGDataModal.addEventListener('show.bs.modal', function (event) {
                var button = event.relatedTarget;
                var indicatorId = button.getAttribute('data-indicator-id');
                var code = button.getAttribute('data-code');
                var title = button.getAttribute('data-title');
                var unit = button.getAttribute('data-unit');

                var modalIndicatorId = addSDGDataModal.querySelector('#modal_indicator_id');
                var modalIndicatorDisplay = addSDGDataModal.querySelector('#modal_indicator_display');
                var modalUnitDisplay = addSDGDataModal.querySelector('#modal_unit_display');
                
                modalIndicatorId.value = indicatorId;
                modalIndicatorDisplay.textContent = code + ' - ' + title;
                
                if (unit) {
                    modalUnitDisplay.textContent = '(' + unit + ')';
                } else {
                    modalUnitDisplay.textContent = '';
                }
            });
        });
    </script>
</div>
<script>
    function moveGoal(id, from, to) {
        const item = document.getElementById('goal_item_' + id);
        const availableList = document.getElementById('availableGoalsList');
        const selectedList = document.getElementById('selectedGoalsList');
        const hiddenInputs = document.getElementById('hiddenInputs');
        
        if (to === 'selected') {
            // Move to selected list
            selectedList.appendChild(item);
            item.classList.add('selected');
            item.setAttribute('onclick', "moveGoal('" + id + "', 'selected', 'available')");
            item.querySelector('.fa-arrow-right').classList.remove('fa-arrow-right', 'text-primary');
            item.querySelector('.ms-auto i').classList.add('fa-times', 'text-danger');
            
            // Add hidden input
            if (!document.getElementById('input_goal_' + id)) {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'selected_goals';
                input.value = id;
                input.id = 'input_goal_' + id;
                hiddenInputs.appendChild(input);
            }
        } else {
            // Move to available list
            availableList.appendChild(item);
            item.classList.remove('selected');
            item.setAttribute('onclick', "moveGoal('" + id + "', 'available', 'selected')");
            item.querySelector('.fa-times').classList.remove('fa-times', 'text-danger');
            item.querySelector('.ms-auto i').classList.add('fa-arrow-right', 'text-primary');
            
            // Remove hidden input
            const input = document.getElementById('input_goal_' + id);
            if (input) {
                input.remove();
            }
        }
    }
</script>
{% endblock %}
