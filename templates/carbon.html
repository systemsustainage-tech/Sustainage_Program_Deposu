{% extends "base.html" %}

{% block title %}{{ _('carbon_title') }} - SDG Platform{% endblock %}

{% block content %}

<div class="row mb-4">
<div class="col-md-12">
<div class="d-flex justify-content-between align-items-center">
<h1><i class="fas fa-smog me-2"></i>{{ _('carbon_title') }}</h1>
<div>
<span class="badge bg-{{ 'success' if manager_available else 'danger' }}">
                    {{ _('module_active') if manager_available else _('module_passive') }}
                </span>
<button class="btn btn-sm btn-outline-secondary ms-2" onclick="history.back()"><i class="bi bi-arrow-left"></i> {{ _('btn_back', 'Geri') }}</button></div>
</div>
<p class="lead text-muted">{{ _('carbon_desc') }}</p>
</div>
</div>

{% if manager_available %}
<!-- Stats Overview -->
<div class="row mb-4">
<div class="col-md-12">
<div class="card bg-light border-0">
<div class="card-body d-flex justify-content-between align-items-center">
<div>
<h5 class="card-title text-muted mb-0">{{ _('total_carbon_footprint') }}</h5>
<h2 class="display-4 fw-bold text-dark mb-0">{{ "{:,.2f}".format(stats.total_co2e) }} <span class="fs-4 text-muted">kg CO2e</span></h2>
</div>
<div class="text-end">
<button class="btn btn-primary btn-lg" data-bs-target="#addCarbonModal" data-bs-toggle="modal" type="button">
<i class="bi bi-plus-lg"></i> {{ _('add_new', 'Yeni Ekle') }}
                    </button>
</div>
</div>
</div>
</div>
</div>
<div class="row">
<div class="col-md-4 mb-4">
<div class="card h-100 border-0 shadow-sm">
<div class="card-body text-center">
<i class="fas fa-fire fa-3x text-danger mb-3"></i>
<h5 class="card-title">{{ _('scope_1_title') }}</h5>
<h3 class="fw-bold my-3">{{ "{:,.2f}".format(stats.scope1) }} <small class="text-muted fs-6">kg CO2e</small></h3>
<p class="card-text text-muted small">{{ _('scope_1_desc') }}</p>
<button class="btn btn-sm btn-outline-primary mt-2" data-bs-target="#addCarbonModal" data-bs-toggle="modal" onclick="setCarbonScope('Scope 1')" type="button">
                    {{ _('btn_add_data') }}
                </button>
</div>
</div>
</div>
<div class="col-md-4 mb-4">
<div class="card h-100 border-0 shadow-sm">
<div class="card-body text-center">
<i class="fas fa-bolt fa-3x text-warning mb-3"></i>
<h5 class="card-title">{{ _('scope_2_title') }}</h5>
<h3 class="fw-bold my-3">{{ "{:,.2f}".format(stats.scope2) }} <small class="text-muted fs-6">kg CO2e</small></h3>
<p class="card-text text-muted small">{{ _('scope_2_desc') }}</p>
<button class="btn btn-sm btn-outline-primary mt-2" data-bs-target="#addCarbonModal" data-bs-toggle="modal" onclick="setCarbonScope('Scope 2')" type="button">
                    {{ _('btn_add_data') }}
                </button>
</div>
</div>
</div>
<div class="col-md-4 mb-4">
<div class="card h-100 border-0 shadow-sm">
<div class="card-body text-center">
<i class="fas fa-plane fa-3x text-info mb-3"></i>
<h5 class="card-title">{{ _('scope_3_title') }}</h5>
<h3 class="fw-bold my-3">{{ "{:,.2f}".format(stats.scope3) }} <small class="text-muted fs-6">kg CO2e</small></h3>
<p class="card-text text-muted small">{{ _('scope_3_desc') }}</p>
<button class="btn btn-sm btn-outline-primary mt-2" data-bs-target="#addCarbonModal" data-bs-toggle="modal" onclick="setCarbonScope('Scope 3')" type="button">
                    {{ _('btn_add_data') }}
                </button>
</div>
</div>
</div>
</div>
<!-- Recent Data Table -->
<div class="row mt-4">
<div class="col-12">
<div class="card shadow-sm border-0">
<div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center">
<h5 class="mb-0">{{ _('recent_data_entries') }}</h5>
</div>
<div class="table-responsive">
<table class="table table-hover align-middle mb-0">
<thead class="table-light">
<tr>
<th>{{ _('table_scope') }}</th>
<th>{{ _('table_category') }}</th>
<th>{{ _('table_quantity') }}</th>
<th>{{ _('table_unit') }}</th>
<th>{{ _('table_emissions') }} (kg CO2e)</th>
<th>{{ _('table_period') }}</th>
<th>{{ _('table_date') }}</th>
</tr>
</thead>
<tbody>
                        {% for row in recent_data %}
                        <tr>
<td><span class="badge bg-secondary">{{ row['scope'] }}</span></td>
<td>{{ row['category'] }}</td>
<td>{{ row['quantity'] }}</td>
<td>{{ row['unit'] }}</td>
<td class="fw-bold">{{ row['co2e_emissions'] }}</td>
<td>{{ row['period'] }}</td>
<td class="text-muted small">{{ row['created_at'][:10] if row['created_at'] else '' }}</td>
</tr>
                        {% else %}
                        <tr>
<td class="text-center py-4 text-muted" colspan="7">{{ _('no_data_yet') }}</td>
</tr>
                        {% endfor %}
                    </tbody>
</table>
</div>
</div>
</div>
</div>

{% else %}
<div class="alert alert-warning">
<h4 class="alert-heading">{{ _('module_load_error') }}</h4>
<p>Karbon Yönetimi {{ _('module_unavailable') }}</p>
</div>
{% endif %}

<!-- Add Carbon Modal -->
<div aria-hidden="true" class="modal fade" id="addCarbonModal" tabindex="-1">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title">{{ _('add_new_carbon', 'Yeni Karbon Emisyonu Ekle') }}</h5>
<button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
</div>
<form action="{{ url_for('data_add') }}" method="POST">
<input name="data_type" type="hidden" value="carbon"/>
<div class="modal-body">
<div class="mb-3">
<label class="form-label" for="scope">{{ _('scope', 'Kapsam') }}</label>
<select class="form-select" id="scope" name="scope" onchange="updateSourceTypeOptions()" required="">
<option value="Scope 1">Scope 1 (Doğrudan)</option>
<option value="Scope 2">Scope 2 (Dolaylı Enerji)</option>
<option value="Scope 3">Scope 3 (Diğer Dolaylı)</option>
</select>
</div>
<div class="mb-3">
<label class="form-label" for="source_type">{{ _('source_type', 'Kaynak/Yakıt Türü') }}</label>
<input class="form-control" id="source_type" list="sourceTypeOptions" name="source_type" placeholder="Örn: Doğalgaz, Elektrik, Uçak Yolculuğu" required="" type="text"/>
<datalist id="sourceTypeOptions">
<!-- Options will be populated by JS -->
</datalist>
</div>
<div class="row">
<div class="col-md-6 mb-3">
<label class="form-label" for="amount">{{ _('amount', 'Miktar') }}</label>
<input class="form-control" id="amount" name="amount" required="" step="0.01" type="number"/>
</div>
<div class="col-md-6 mb-3">
<label class="form-label" for="unit">{{ _('unit', 'Birim') }}</label>
<select class="form-select" id="unit" name="unit" required="">
<option value="m3">m3</option>
<option value="liter">Litre</option>
<option value="kg">kg</option>
<option value="kWh">kWh</option>
<option value="km">km</option>
</select>
</div>
</div>
<div class="mb-3">
<label class="form-label" for="date">{{ _('date', 'Tarih') }}</label>
<input class="form-control" id="date" name="date" required="" type="date"/>
</div>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" data-bs-dismiss="modal" type="button">{{ _('btn_cancel', 'İptal') }}</button>
<button class="btn btn-primary" type="submit">{{ _('btn_save', 'Kaydet') }}</button>
</div>
</form>
</div>
</div>
</div>
<script>
function setCarbonScope(scope) {
    const scopeSelect = document.getElementById('scope');
    if (scopeSelect) {
        scopeSelect.value = scope;
        updateSourceTypeOptions();
    }
}

function updateSourceTypeOptions() {
    const scope = document.getElementById('scope').value;
    const datalist = document.getElementById('sourceTypeOptions');
    datalist.innerHTML = '';
    
    let options = [];
    if (scope === 'Scope 1') {
        options = ['Doğalgaz', 'Motorin', 'Benzin', 'LPG', 'Kömür'];
    } else if (scope === 'Scope 2') {
        options = ['Elektrik'];
    } else if (scope === 'Scope 3') {
        options = ['Uçak Yolculuğu', 'Karayolu', 'Kağıt', 'Su Tüketimi', 'Atık'];
    }
    
    options.forEach(opt => {
        const option = document.createElement('option');
        option.value = opt;
        datalist.appendChild(option);
    });
}
// Initialize
document.addEventListener('DOMContentLoaded', updateSourceTypeOptions);
</script>

{% endblock %}
