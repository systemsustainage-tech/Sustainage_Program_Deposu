{% extends "base.html" %}

{% block title %}ESRS {{ _('esrs_materiality_analysis', 'Çifte Önemlilik Analizi') }} - SDG{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="d-flex justify-content-between align-items-center">
            <h1><i class="fas fa-balance-scale me-2"></i>ESRS {{ _('esrs_materiality_analysis', 'Çifte Önemlilik Analizi') }}</h1>
            <div>
                <span class="badge bg-{{ 'success' if manager_available else 'danger' }}">
                    {{ _('module_active_badge') if manager_available else _('module_passive_badge') }}
                </span>
                <button class="btn btn-sm btn-outline-secondary ms-2" onclick="history.back()"><i class="bi bi-arrow-left"></i> {{ _('btn_back', 'Geri') }}</button>
            </div>
        </div>
        <p class="lead text-muted">{{ _('esrs_desc', 'ESRS (European Sustainability Reporting Standards) kapsamında etki ve finansal önemlilik analizi.') }}</p>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-8">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-header bg-white">
                <h5 class="mb-0">{{ _('esrs_materiality_matrix', 'Önemlilik Matrisi') }}</h5>
            </div>
            <div class="card-body">
                <canvas id="materialityChart"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-body">
                <h5 class="card-title">{{ _('esrs_actions', 'İşlemler') }}</h5>
                <p class="card-text">{{ _('esrs_add_desc', 'Yeni bir önemlilik konusu ekleyin.') }}</p>
                <button class="btn btn-primary w-100 mb-3" data-bs-toggle="modal" data-bs-target="#addMaterialityModal">
                    <i class="fas fa-plus me-2"></i>{{ _('btn_add_topic', 'Konu Ekle') }}
                </button>
                <hr>
                <h6>{{ _('esrs_summary', 'Özet') }}</h6>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        {{ _('total_topics', 'Toplam Konu') }}
                        <span class="badge bg-primary rounded-pill">{{ materiality_items|length }}</span>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Reporting Section: Radar and Bar Charts -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-header bg-white">
                <h5 class="mb-0">{{ _('esrs_radar_chart', 'Konu Analizi (Radar)') }}</h5>
            </div>
            <div class="card-body">
                <canvas id="radarChart"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-header bg-white">
                <h5 class="mb-0">{{ _('esrs_distribution_chart', 'Puan Dağılımı (Kutu/Bar)') }}</h5>
            </div>
            <div class="card-body">
                <canvas id="distributionChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Add Materiality Modal -->
<div class="modal fade" id="addMaterialityModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ _('esrs_add_title', 'Yeni Önemlilik Konusu Ekle') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('esrs_materiality_add') }}" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">{{ _('esrs_topic', 'Konu Başlığı') }}</label>
                        <input type="text" class="form-control" name="topic" required placeholder="Örn: İklim Değişikliği, Su Yönetimi...">
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">{{ _('esrs_impact_score', 'Etki Puanı (1-5)') }}</label>
                            <select class="form-select" name="impact_score" required>
                                <option value="1">1 - Çok Düşük</option>
                                <option value="2">2 - Düşük</option>
                                <option value="3">3 - Orta</option>
                                <option value="4">4 - Yüksek</option>
                                <option value="5">5 - Çok Yüksek</option>
                            </select>
                            <div class="form-text">{{ _('esrs_impact_help', 'Çevre ve toplum üzerindeki etkinin büyüklüğü') }}</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">{{ _('esrs_likelihood', 'Olasılık (1-5)') }}</label>
                            <select class="form-select" name="likelihood" required>
                                <option value="1">1 - Çok Düşük</option>
                                <option value="2">2 - Düşük</option>
                                <option value="3">3 - Orta</option>
                                <option value="4">4 - Yüksek</option>
                                <option value="5">5 - Çok Yüksek</option>
                            </select>
                             <div class="form-text">{{ _('esrs_likelihood_help', 'Etkinin gerçekleşme olasılığı') }}</div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">{{ _('esrs_financial_effect', 'Finansal Etki') }}</label>
                        <textarea class="form-control" name="financial_effect" rows="2" placeholder="Şirket üzerindeki finansal risk ve fırsatlar..."></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">{{ _('esrs_environmental_effect', 'Çevresel/Sosyal Etki') }}</label>
                        <textarea class="form-control" name="environmental_effect" rows="2" placeholder="Çevre ve toplum üzerindeki etkiler..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('btn_cancel', 'İptal') }}</button>
                    <button type="submit" class="btn btn-primary">{{ _('btn_save', 'Kaydet') }}</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% if materiality_items %}
<div class="row">
    <div class="col-md-12">
        <div class="card shadow-sm border-0">
            <div class="card-header bg-light">
                <h5 class="mb-0">{{ _('esrs_list_title', 'Önemlilik Listesi') }}</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>{{ _('esrs_topic', 'Konu') }}</th>
                                <th>{{ _('esrs_impact', 'Etki') }}</th>
                                <th>{{ _('esrs_likelihood', 'Olasılık') }}</th>
                                <th>{{ _('esrs_financial', 'Finansal Etki') }}</th>
                                <th>{{ _('esrs_environmental', 'Çevresel Etki') }}</th>
                                <th>{{ _('actions', 'İşlemler') }}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in materiality_items %}
                            <tr>
                                <td><strong>{{ item.topic }}</strong></td>
                                <td><span class="badge bg-{{ 'danger' if item.impact_score >= 4 else 'warning' if item.impact_score == 3 else 'success' }}">{{ item.impact_score }}</span></td>
                                <td><span class="badge bg-secondary">{{ item.likelihood }}</span></td>
                                <td><small>{{ item.financial_effect }}</small></td>
                                <td><small>{{ item.environmental_effect }}</small></td>
                                <td>
                                    <form action="{{ url_for('esrs_materiality_delete', item_id=item.id) }}" method="POST" onsubmit="return confirm('{{ _('confirm_delete', 'Silmek istediğinize emin misiniz?') }}');" style="display:inline;">
                                        <button type="submit" class="btn btn-sm btn-outline-danger"><i class="fas fa-trash"></i></button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% else %}
<div class="alert alert-info mt-3">
    {{ _('esrs_no_data', 'Henüz önemlilik analizi verisi girilmemiş.') }}
</div>
{% endif %}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const ctx = document.getElementById('materialityChart').getContext('2d');
        
        // Data preparation
        const labels = [{% for item in materiality_items %}"{{ item.topic }}",{% endfor %}];
        const impactData = [{% for item in materiality_items %}{{ item.impact_score }},{% endfor %}];
        const likelihoodData = [{% for item in materiality_items %}{{ item.likelihood }},{% endfor %}];
        
        // Scatter plot data structure
        const scatterData = [];
        {% for item in materiality_items %}
        scatterData.push({
            x: {{ item.impact_score }},
            y: {{ item.likelihood }},
            r: 10, // radius
            label: "{{ item.topic }}" 
        });
        {% endfor %}

        // 1. Bubble Chart (Materiality Matrix)
        new Chart(ctx, {
            type: 'bubble',
            data: {
                datasets: [{
                    label: '{{ _("esrs_materiality_items", "Önemlilik Konuları") }}',
                    data: scatterData,
                    backgroundColor: 'rgba(54, 162, 235, 0.6)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.raw.label + ' (Etki: ' + context.raw.x + ', Olasılık: ' + context.raw.y + ')';
                            }
                        }
                    },
                    title: {
                        display: true,
                        text: '{{ _("esrs_matrix_title", "Önemlilik Matrisi (Etki vs Olasılık)") }}'
                    }
                },
                scales: {
                    x: {
                        title: { display: true, text: '{{ _("esrs_impact", "Etki") }}' },
                        min: 0, max: 6
                    },
                    y: {
                        title: { display: true, text: '{{ _("esrs_likelihood", "Olasılık") }}' },
                        min: 0, max: 6
                    }
                }
            }
        });

        // 2. Radar Chart (Topic Analysis)
        const radarCtx = document.getElementById('radarChart').getContext('2d');
        new Chart(radarCtx, {
            type: 'radar',
            data: {
                labels: labels,
                datasets: [{
                    label: '{{ _("esrs_impact", "Etki") }}',
                    data: impactData,
                    fill: true,
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    borderColor: 'rgb(255, 99, 132)',
                    pointBackgroundColor: 'rgb(255, 99, 132)',
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: 'rgb(255, 99, 132)'
                }, {
                    label: '{{ _("esrs_likelihood", "Olasılık") }}',
                    data: likelihoodData,
                    fill: true,
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    borderColor: 'rgb(54, 162, 235)',
                    pointBackgroundColor: 'rgb(54, 162, 235)',
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: 'rgb(54, 162, 235)'
                }]
            },
            options: {
                responsive: true,
                elements: { line: { borderWidth: 3 } },
                scales: {
                    r: {
                        angleLines: { display: false },
                        suggestedMin: 0,
                        suggestedMax: 5
                    }
                }
            }
        });

        // 3. Distribution Chart (Box Proxy - Range & Average)
        const getStats = (data) => {
            if (data.length === 0) return { min: 0, max: 0, avg: 0 };
            const min = Math.min(...data);
            const max = Math.max(...data);
            const avg = data.reduce((a, b) => a + b, 0) / data.length;
            return { min, max, avg };
        };
        const impactStats = getStats(impactData);
        const likelihoodStats = getStats(likelihoodData);

        const distCtx = document.getElementById('distributionChart').getContext('2d');
        new Chart(distCtx, {
            type: 'bar',
            data: {
                labels: ['{{ _("esrs_impact", "Etki") }}', '{{ _("esrs_likelihood", "Olasılık") }}'],
                datasets: [
                    {
                        label: '{{ _("esrs_range", "Aralık (Min-Max)") }}',
                        data: [
                            [impactStats.min, impactStats.max],
                            [likelihoodStats.min, likelihoodStats.max]
                        ],
                        backgroundColor: 'rgba(75, 192, 192, 0.5)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1,
                        barPercentage: 0.5,
                        order: 2
                    },
                    {
                        label: '{{ _("esrs_average", "Ortalama") }}',
                        data: [impactStats.avg, likelihoodStats.avg],
                        type: 'line',
                        borderColor: 'rgba(255, 159, 64, 1)',
                        backgroundColor: 'rgba(255, 159, 64, 1)',
                        borderWidth: 2,
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        order: 1
                    }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 6,
                        title: { display: true, text: '{{ _("esrs_score", "Puan") }}' }
                    }
                }
            }
        });
    });
</script>

{% endblock %}
