{% extends "base.html" %}
{% from "includes/pagination.html" import render_pagination %}

{% block title %}{{ lang('data_management_title') }} - SDG{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
<h1 class="h2">{{ lang('data_management_title') }}</h1>
<div class="btn-toolbar mb-2 mb-md-0">
        {% if session.role|lower in ['admin', 'super_admin', 'test admin'] %}
        <a class="btn btn-sm btn-primary" href="{{ url_for('data_add') }}">
<i class="bi bi-plus-circle"></i> {{ lang('btn_new_data_entry') }}
        </a>
        {% endif %}
    <button class="btn btn-sm btn-outline-secondary ms-2" onclick="history.back()"><i class="bi bi-arrow-left"></i> {{ lang('btn_back', 'Geri') }}</button></div>
</div>

<ul class="nav nav-tabs mb-4" id="dataTab" role="tablist">
<li class="nav-item" role="presentation">
<a class="nav-link {% if active_tab == 'carbon' %}active{% endif %}" href="{{ url_for('data', tab='carbon') }}">{{ lang('tab_carbon') }}</a>
</li>
<li class="nav-item" role="presentation">
<a class="nav-link {% if active_tab == 'energy' %}active{% endif %}" href="{{ url_for('data', tab='energy') }}">{{ lang('tab_energy') }}</a>
</li>
<li class="nav-item" role="presentation">
<a class="nav-link {% if active_tab == 'water' %}active{% endif %}" href="{{ url_for('data', tab='water') }}">{{ lang('tab_water') }}</a>
</li>
<li class="nav-item" role="presentation">
<a class="nav-link {% if active_tab == 'waste' %}active{% endif %}" href="{{ url_for('data', tab='waste') }}">{{ lang('tab_waste') }}</a>
</li>
</ul>

<div class="tab-content" id="dataTabContent">
<!-- Carbon Tab -->
{% if active_tab == 'carbon' %}
<div class="tab-pane fade show active" id="carbon" role="tabpanel">
<div class="table-responsive">
<table class="table table-sm table-hover">
<thead>
<tr>
<th>{{ lang('col_scope') }}</th>
<th>{{ lang('col_category') }}</th>
<th>{{ lang('col_quantity') }}</th>
<th>{{ lang('col_unit') }}</th>
<th>CO2e (kg)</th>
<th>{{ lang('col_date') }}</th>
</tr>
</thead>
<tbody>
                    {% for item in data.carbon %}
                    <tr>
<td>{{ item['scope'] }}</td>
<td>{{ item['category'] }}</td>
<td>{{ item['quantity'] }}</td>
<td>{{ item['unit'] }}</td>
<td>{{ item['co2e_emissions'] }}</td>
<td>{{ item['period'] or item['created_at'] }}</td>
</tr>
                    {% else %}
                    <tr><td class="text-center" colspan="6">{{ lang('no_data') }}</td></tr>
                    {% endfor %}
                </tbody>
</table>
</div>
{{ render_pagination(pagination, 'data', tab='carbon') }}
</div>
{% endif %}

<!-- Energy Tab -->
{% if active_tab == 'energy' %}
<div class="tab-pane fade show active" id="energy" role="tabpanel">
<div class="table-responsive">
<table class="table table-sm table-hover">
<thead>
<tr>
<th>{{ lang('col_year_month') }}</th>
<th>{{ lang('col_type') }}</th>
<th>{{ lang('col_consumption') }}</th>
<th>{{ lang('col_unit') }}</th>
<th>{{ lang('col_cost') }}</th>
</tr>
</thead>
<tbody>
                    {% for item in data.energy %}
                    <tr>
<td>{{ item['year'] }}/{{ item['month'] }}</td>
<td>{{ item['energy_type'] }}</td>
<td>{{ item['consumption_amount'] }}</td>
<td>{{ item['unit'] }}</td>
<td>{{ item['cost'] }}</td>
</tr>
                    {% else %}
                    <tr><td class="text-center" colspan="5">{{ lang('no_data') }}</td></tr>
                    {% endfor %}
                </tbody>
</table>
</div>
{{ render_pagination(pagination, 'data', tab='energy') }}
</div>
{% endif %}

<!-- Water Tab -->
{% if active_tab == 'water' %}
<div class="tab-pane fade show active" id="water" role="tabpanel">
<div class="table-responsive">
<table class="table table-sm table-hover">
<thead>
<tr>
<th>{{ lang('col_year_month') }}</th>
<th>{{ lang('col_type') }}</th>
<th>{{ lang('col_consumption') }}</th>
<th>{{ lang('col_unit') }}</th>
</tr>
</thead>
<tbody>
                    {% for item in data.water %}
                    <tr>
<td>{{ item['year'] }}/{{ item['month'] }}</td>
<td>{{ item['consumption_type'] }}</td>
<td>{{ item['consumption_amount'] }}</td>
<td>{{ item['unit'] }}</td>
</tr>
                    {% else %}
                    <tr><td class="text-center" colspan="4">{{ lang('no_data') }}</td></tr>
                    {% endfor %}
                </tbody>
</table>
</div>
{{ render_pagination(pagination, 'data', tab='water') }}
</div>
{% endif %}

<!-- Waste Tab -->
{% if active_tab == 'waste' %}
<div class="tab-pane fade show active" id="waste" role="tabpanel">
<div class="table-responsive">
<table class="table table-sm table-hover">
<thead>
<tr>
<th>{{ lang('col_year_month') }}</th>
<th>{{ lang('col_type') }}</th>
<th>{{ lang('col_quantity') }}</th>
<th>{{ lang('col_method') }}</th>
<th>{{ lang('col_hazardous') }}</th>
</tr>
</thead>
<tbody>
                    {% for item in data.waste %}
                    <tr>
<td>{{ item['year'] }}/{{ item['month'] }}</td>
<td>{{ item['waste_type'] }}</td>
<td>{{ item['waste_amount'] }}</td>
<td>{{ item['disposal_method'] }}</td>
<td>{{ item['hazardous_status'] }}</td>
</tr>
                    {% else %}
                    <tr><td class="text-center" colspan="5">{{ lang('no_data') }}</td></tr>
                    {% endfor %}
                </tbody>
</table>
</div>
{{ render_pagination(pagination, 'data', tab='waste') }}
</div>
{% endif %}
</div>
{% endblock %}

<!-- Add Data Modal -->
<div aria-hidden="true" class="modal fade" id="addDataModal" tabindex="-1">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title">{{ lang('add_new_data', 'Yeni Veri Girişi') }}</h5>
<button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
</div>
<form action="{{ url_for('data_add') }}" method="POST">
<div class="modal-body">
<div class="mb-3">
<label class="form-label" for="data_type">{{ lang('data_type', 'Veri Tipi') }}</label>
<select class="form-select" id="data_type" name="data_type" onchange="updateDataFields()" required="">
<option value="">{{ lang('select_type', 'Seçiniz') }}</option>
<option value="carbon">{{ lang('carbon', 'Karbon') }}</option>
<option value="energy">{{ lang('energy', 'Enerji') }}</option>
<option value="water">{{ lang('water', 'Su') }}</option>
<option value="waste">{{ lang('waste', 'Atık') }}</option>
</select>
</div>
<div class="mb-3">
<label class="form-label" for="date">{{ lang('date', 'Tarih') }}</label>
<input class="form-control" name="date" required="" type="date"/>
</div>
<!-- Carbon Fields -->
<div class="data-fields" id="carbon_fields" style="display:none;">
<div class="mb-3">
<label class="form-label">{{ lang('scope', 'Kapsam') }}</label>
<select class="form-select" name="scope">
<option value="Scope 1">Scope 1</option>
<option value="Scope 2">Scope 2</option>
<option value="Scope 3">Scope 3</option>
</select>
</div>
<div class="mb-3">
<label class="form-label">{{ lang('category', 'Kategori') }}</label>
<input class="form-control" name="category" type="text"/>
</div>
<div class="mb-3">
<label class="form-label">{{ lang('amount', 'Miktar') }}</label>
<input class="form-control" name="amount" step="0.01" type="number"/>
</div>
</div>
<!-- Energy Fields -->
<div class="data-fields" id="energy_fields" style="display:none;">
<div class="mb-3">
<label class="form-label">{{ lang('energy_type', 'Enerji Tipi') }}</label>
<input class="form-control" name="energy_type" placeholder="Elektrik, Doğalgaz vb." type="text"/>
</div>
<div class="mb-3">
<label class="form-label">{{ lang('consumption', 'Tüketim Miktarı') }}</label>
<input class="form-control" name="consumption_amount" step="0.01" type="number"/>
</div>
<div class="mb-3">
<label class="form-label">{{ lang('cost', 'Maliyet') }}</label>
<input class="form-control" name="cost" step="0.01" type="number"/>
</div>
</div>
<!-- Water Fields -->
<div class="data-fields" id="water_fields" style="display:none;">
<div class="mb-3">
<label class="form-label">{{ lang('water_type', 'Su Tipi') }}</label>
<input class="form-control" name="consumption_type" placeholder="Şebeke Suyu, Kuyu Suyu vb." type="text"/>
</div>
<div class="mb-3">
<label class="form-label">{{ lang('consumption', 'Tüketim Miktarı') }}</label>
<input class="form-control" name="consumption_amount" step="0.01" type="number"/> <!-- Shared name with Energy if simpler, but backend uses different keys? Check backend -->
<!-- Backend: energy -> consumption_amount, water -> consumption_amount. Wait. 
                                 Web App Data Add: 
                                 Energy: consumption = request.form.get('consumption_amount')
                                 Water: consumption = request.form.get('consumption_amount') 
                                 So I can use the same name if I want, but IDs must be unique if I used IDs. I used names.
                                 However, if all fields are in the form, the hidden ones are still submitted? 
                                 If I hide them with display:none, they are still submitted. 
                                 If I name them the same, the last one might overwrite or list.
                                 Since only one section is visible, the user only fills one. But the browser submits empty values for others.
                                 Backend:
                                 if dtype == 'energy': cons = req.form.get('consumption_amount')
                                 if dtype == 'water': cons = req.form.get('consumption_amount')
                                 This is fine as long as I don't fill both.
                                 BUT, if I name them the same in HTML, the browser sends multiple values for the same key.
                                 Flask `request.form.get` usually takes the first one.
                                 Better to name them distinctly if possible or rely on the fact that only one is filled?
                                 Actually, if I use the SAME name, I should be careful. 
                                 Let's look at `web_app.py` again.
                                 Energy: `consumption_amount`
                                 Water: `consumption_amount`
                                 Since they are separate logic blocks in backend, it's okay IF the user only fills the visible one.
                                 BUT if the user fills Energy, then switches to Water, the Energy value remains in the hidden input.
                                 It's better to clear values on switch or use different names.
                                 Backend expects specific names.
                                 Energy and Water use the SAME name `consumption_amount`.
                                 I will use `energy_consumption` and `water_consumption` in the form, and update backend? 
                                 NO, I should follow backend.
                                 Backend code:
                                 Energy: `consumption = float(request.form.get('consumption_amount') or 0)`
                                 Water: `quantity = float(request.form.get('consumption_amount') or 0)`
                                 
                                 Issue: If I have two inputs with `name="consumption_amount"`, Flask receives a list or the first one.
                                 If I have `<input name="consumption_amount">` in Energy div and another in Water div.
                                 They will both be submitted.
                                 If I leave one empty, it's `""`.
                                 If I fill Energy, Water is empty.
                                 Flask `request.form.get` might get the empty one if it comes first!
                                 
                                 Solution: Use a single input for `consumption_amount` and move it to a common area?
                                 No, Energy has Cost, Water doesn't.
                                 
                                 Better Solution: JavaScript to disable inputs in hidden divs. Disabled inputs are not submitted.
                            -->
</div>
</div>
<!-- Waste Fields -->
<div class="data-fields" id="waste_fields" style="display:none;">
<div class="mb-3">
<label class="form-label">{{ lang('waste_type', 'Atık Tipi') }}</label>
<input class="form-control" name="waste_type" type="text"/>
</div>
<div class="mb-3">
<label class="form-label">{{ lang('amount', 'Miktar') }}</label>
<input class="form-control" name="waste_amount" step="0.01" type="number"/>
</div>
<div class="mb-3">
<label class="form-label">{{ lang('disposal_method', 'Bertaraf Yöntemi') }}</label>
<input class="form-control" name="disposal_method" type="text"/>
</div>
<div class="mb-3">
<label class="form-label">{{ lang('hazardous', 'Tehlikeli mi?') }}</label>
<select class="form-select" name="hazardous_status">
<option value="Hayır">{{ lang('no', 'Hayır') }}</option>
<option value="Evet">{{ lang('yes', 'Evet') }}</option>
</select>
</div>
</div>
<div class="mb-3">
<label class="form-label">{{ lang('unit', 'Birim') }}</label>
<input class="form-control" name="unit" placeholder="kg, kWh, m3, ton vb." type="text"/>
</div>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" data-bs-dismiss="modal" type="button">{{ lang('cancel', 'İptal') }}</button>
<button class="btn btn-primary" type="submit">{{ lang('save', 'Kaydet') }}</button>
</div>
</form>
</div>
</div>
</div>
<script>
function updateDataFields() {
    var type = document.getElementById('data_type').value;
    var fields = document.getElementsByClassName('data-fields');
    for(var i=0; i<fields.length; i++) {
        fields[i].style.display = 'none';
        // Disable all inputs in hidden fields to prevent submission conflicts
        var inputs = fields[i].getElementsByTagName('input');
        for(var j=0; j<inputs.length; j++) inputs[j].disabled = true;
        var selects = fields[i].getElementsByTagName('select');
        for(var j=0; j<selects.length; j++) selects[j].disabled = true;
    }
    
    if(type) {
        var activeDiv = document.getElementById(type + '_fields');
        if(activeDiv) {
            activeDiv.style.display = 'block';
            // Enable inputs in active field
            var inputs = activeDiv.getElementsByTagName('input');
            for(var j=0; j<inputs.length; j++) inputs[j].disabled = false;
            var selects = activeDiv.getElementsByTagName('select');
            for(var j=0; j<selects.length; j++) selects[j].disabled = false;
        }
    }
}
</script>
