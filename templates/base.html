<!doctype html>
<html lang="tr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}Sustainage{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <style>
      body { background-color: #f8f9fa; }
      .navbar { margin-bottom: 20px; }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <div class="container">
        <a class="navbar-brand" href="/">Sustainage</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <!-- Dark Mode Toggle -->
            <li class="nav-item">
              <a class="nav-link" href="#" id="darkModeToggle" title="Dark/Light Mode">
                <i class="bi bi-moon-fill"></i>
              </a>
            </li>

            <!-- Language Switcher -->
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" id="langDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi bi-globe"></i> {{ session.get('lang', 'tr')|upper }}
              </a>
              <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="langDropdown">
                <li><a class="dropdown-item" href="{{ url_for('set_language', lang='tr') }}">Türkçe</a></li>
                <li><a class="dropdown-item" href="{{ url_for('set_language', lang='en') }}">English</a></li>
                <li><a class="dropdown-item" href="{{ url_for('set_language', lang='de') }}">Deutsch</a></li>
                <li><a class="dropdown-item" href="{{ url_for('set_language', lang='fr') }}">Français</a></li>
              </ul>
            </li>

            {% if session.get('user') %}
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('dashboard') }}">{{ _('dashboard', 'Dashboard') }}</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('reporting_journey') }}">{{ _('roadmap', 'Yol Haritası') }}</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('reports') }}">{{ _('reports', 'Raporlar') }}</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('data') }}">{{ _('data_entry', 'Veri Girişi') }}</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('targets_module') }}">{{ _('targets', 'Hedefler') }}</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('help_module') }}">{{ _('help', 'Yardım') }}</a>
            </li>
            
            {% if session.role|lower in ['admin', 'super_admin', 'test admin'] %}
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                {{ _('management', 'Yönetim') }}
              </a>
              <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                <li><a class="dropdown-item" href="{{ url_for('users') }}">{{ _('users', 'Kullanıcılar') }}</a></li>
                <li><a class="dropdown-item" href="{{ url_for('companies') }}">{{ _('companies', 'Şirketler') }}</a></li>
                <li><a class="dropdown-item" href="{{ url_for('company_info_edit', company_id=g.company_id) }}">{{ _('company_info', 'Firma Bilgileri') }}</a></li>
                <li><a class="dropdown-item" href="{{ url_for('supplier_portal.login') }}" target="_blank"><i class="bi bi-box-arrow-in-right"></i> {{ _('supplier_login', 'Tedarikçi Girişi') }}</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="{{ url_for('user_add') }}">{{ _('new_user', 'Yeni Kullanıcı') }}</a></li>
                <li><a class="dropdown-item" href="{{ url_for('company_add') }}">{{ _('new_company', 'Yeni Şirket') }}</a></li>
                {% if session.role and session.role|lower in ['super_admin', 'admin', 'test admin'] %}
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item text-danger" href="{{ url_for('super_admin_panel') }}">{{ _('admin_panel', 'Super Admin Paneli') }}</a></li>
                {% endif %}
              </ul>
            </li>
            {% endif %}

            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('logout') }}">{{ _('logout', 'Çıkış') }}</a>
            </li>
            {% else %}
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('login') }}">{{ _('login', 'Giriş') }}</a>
            </li>
            {% endif %}
          </ul>
        </div>
      </div>
    </nav>

    <div class="container">
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
              {{ message }}
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
          {% endfor %}
        {% endif %}
      {% endwith %}

      {% block content %}{% endblock %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- DataTables JS -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    
    <script>
      // Dark Mode Logic
      document.addEventListener('DOMContentLoaded', (event) => {
        const html = document.documentElement;
        const darkModeToggle = document.getElementById('darkModeToggle');
        
        if (darkModeToggle) {
          const icon = darkModeToggle.querySelector('i');
          
          // Load preference
          const savedTheme = localStorage.getItem('theme') || 'light';
          html.setAttribute('data-bs-theme', savedTheme);
          updateIcon(savedTheme);
          
          darkModeToggle.addEventListener('click', () => {
            const currentTheme = html.getAttribute('data-bs-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            
            html.setAttribute('data-bs-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateIcon(newTheme);
          });
          
          function updateIcon(theme) {
            if (theme === 'dark') {
              icon.classList.remove('bi-moon-fill');
              icon.classList.add('bi-sun-fill');
            } else {
              icon.classList.remove('bi-sun-fill');
              icon.classList.add('bi-moon-fill');
            }
          }
        }
        
        // Initialize DataTables
        // Add 'data-table' class to any table you want to enhance, OR it applies to all .table by default
        if ($.fn.DataTable) {
          const lang = document.documentElement.lang || 'tr';
          let langUrl = "//cdn.datatables.net/plug-ins/1.13.6/i18n/tr.json";
          
          if (lang === 'en') langUrl = "//cdn.datatables.net/plug-ins/1.13.6/i18n/en-GB.json";
          else if (lang === 'de') langUrl = "//cdn.datatables.net/plug-ins/1.13.6/i18n/de-DE.json";
          else if (lang === 'fr') langUrl = "//cdn.datatables.net/plug-ins/1.13.6/i18n/fr-FR.json";
          else if (lang === 'es') langUrl = "//cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json";
          else if (lang === 'ru') langUrl = "//cdn.datatables.net/plug-ins/1.13.6/i18n/ru.json";

          $('.table:not(.no-datatable)').DataTable({
            language: {
              url: langUrl
            },
            responsive: true,
            retrieve: true, // Re-initialization hatasını önle
            paging: true,
            searching: true,
            ordering: true
          });
        }
      });

      // Auto-dismiss alerts after 5 seconds
      document.addEventListener('DOMContentLoaded', function() {
        setTimeout(function() {
          var alerts = document.querySelectorAll('.alert');
          alerts.forEach(function(alert) {
            var bsAlert = new bootstrap.Alert(alert);
            bsAlert.close();
          });
        }, 5000);
      });
    </script>
  </body>
</html>
