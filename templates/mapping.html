{% extends "base.html" %}

{% block title %}{{ _('mapping_title', 'Mapping') }} - SDG{% endblock %}

{% block content %}

<div class="row mb-4">
    <div class="col-md-12">
        <div class="d-flex justify-content-between align-items-center">
            <h1><i class="fas fa-cube me-2"></i>{{ _('mapping_title', 'Eşleştirme Yönetimi') }}</h1>
            <div>
                <form action="{{ url_for('mapping_generate_suggestions') }}" method="POST" class="d-inline">
                    <button type="submit" class="btn btn-sm btn-outline-info ms-2">
                        <i class="fas fa-magic"></i> Otomatik Öneri Oluştur
                    </button>
                </form>
                <button class="btn btn-sm btn-outline-secondary ms-2" onclick="history.back()"><i class="bi bi-arrow-left"></i> {{ _('btn_back', 'Geri') }}</button>
            </div>
        </div>
        <p class="lead text-muted">{{ _('mapping_desc', 'Standartlar arası eşleştirmeleri ve otomatik önerileri yönetin.') }}</p>
    </div>
</div>

<!-- Stats -->
<div class="row mb-4">
    {% for key, value in stats.items() %}
    <div class="col-md-4 mb-3">
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center">
                <h6 class="text-muted text-uppercase small">{{ key|replace('_', ' ')|title }}</h6>
                <h3 class="mb-0 text-primary">{{ value }}</h3>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Tabs -->
<ul class="nav nav-tabs mb-4" id="mappingTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="mappings-tab" data-bs-toggle="tab" data-bs-target="#mappings" type="button" role="tab" aria-controls="mappings" aria-selected="true">
            Mevcut Eşleştirmeler
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="suggestions-tab" data-bs-toggle="tab" data-bs-target="#suggestions" type="button" role="tab" aria-controls="suggestions" aria-selected="false">
            Öneriler {% if suggestions %}<span class="badge bg-danger">{{ suggestions|length }}</span>{% endif %}
        </button>
    </li>
</ul>

<div class="tab-content" id="mappingTabsContent">
    <!-- Existing Mappings -->
    <div class="tab-pane fade show active" id="mappings" role="tabpanel" aria-labelledby="mappings-tab">
        <div class="card shadow-sm border-0">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Kaynak</th>
                                <th>Kod</th>
                                <th>Hedef</th>
                                <th>Kod</th>
                                <th>Tip</th>
                                <th>Güç</th>
                                <th>Onaylı</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for m in mappings %}
                            <tr>
                                <td>{{ m.source_standard }}</td>
                                <td>
                                    <span data-bs-toggle="tooltip" title="{{ m.source_description }}">
                                        {{ m.source_code }}
                                    </span>
                                </td>
                                <td>{{ m.target_standard }}</td>
                                <td>
                                    <span data-bs-toggle="tooltip" title="{{ m.target_description }}">
                                        {{ m.target_code }}
                                    </span>
                                </td>
                                <td>{{ m.mapping_type }}</td>
                                <td>{{ m.mapping_strength }}</td>
                                <td>
                                    {% if m.verified %}
                                    <i class="bi bi-check-circle-fill text-success"></i>
                                    {% else %}
                                    <i class="bi bi-circle text-muted"></i>
                                    {% endif %}
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="7" class="text-center">Kayıt bulunamadı.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Suggestions -->
    <div class="tab-pane fade" id="suggestions" role="tabpanel" aria-labelledby="suggestions-tab">
        <div class="card shadow-sm border-0">
            <div class="card-body">
                {% if suggestions %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Kaynak</th>
                                <th>Hedef</th>
                                <th>Benzerlik Skoru</th>
                                <th>Açıklama</th>
                                <th>Tarih</th>
                                <th>İşlemler</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for s in suggestions %}
                            <tr>
                                <td>{{ s.source_standard }} {{ s.source_code }}</td>
                                <td>{{ s.target_standard }} {{ s.target_code }}</td>
                                <td>
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar" role="progressbar" style="width: {{ s.confidence_score * 100 }}%;" aria-valuenow="{{ s.confidence_score * 100 }}" aria-valuemin="0" aria-valuemax="100">
                                            {{ '%0.2f'|format(s.confidence_score) }}
                                        </div>
                                    </div>
                                </td>
                                <td>{{ s.suggestion_reason }}</td>
                                <td>{{ s.created_at }}</td>
                                <td>
                                    <form action="{{ url_for('mapping_approve_suggestion', id=s.id) }}" method="POST" class="d-inline">
                                        <button type="submit" class="btn btn-sm btn-success" title="Onayla">
                                            <i class="bi bi-check-lg"></i>
                                        </button>
                                    </form>
                                    <form action="{{ url_for('mapping_reject_suggestion', id=s.id) }}" method="POST" class="d-inline">
                                        <button type="submit" class="btn btn-sm btn-danger" title="Reddet">
                                            <i class="bi bi-x-lg"></i>
                                        </button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5 text-muted">
                    <i class="bi bi-inbox display-4"></i>
                    <p class="mt-3">Bekleyen öneri bulunmamaktadır.</p>
                    <p>Yeni öneriler oluşturmak için "Otomatik Öneri Oluştur" butonunu kullanabilirsiniz.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% endblock %}
