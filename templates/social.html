{% extends "base.html" %}

{% block title %}{{ lang('social_title') }} - SDG{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const trends = JSON.parse('{{ trends | tojson | replace("\'", "\\\'") | safe }}');
        
        if (trends && trends.years && trends.years.length > 0) {
            // Satisfaction Chart
            const satCtx = document.getElementById('satisfactionChart');
            if (satCtx) {
                new Chart(satCtx, {
                    type: 'line',
                    data: {
                        labels: trends.years,
                        datasets: [{
                            label: "{{ lang('satisfaction_score', 'Memnuniyet Skoru') }}",
                            data: trends.satisfaction,
                            borderColor: '#0dcaf0', // info color
                            backgroundColor: 'rgba(13, 202, 240, 0.1)',
                            tension: 0.3,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100
                            }
                        }
                    }
                });
            }

            // Turnover Chart
            const turnCtx = document.getElementById('turnoverChart');
            if (turnCtx) {
                new Chart(turnCtx, {
                    type: 'bar',
                    data: {
                        labels: trends.years,
                        datasets: [{
                            label: "{{ lang('turnover_rate', 'Devir Hızı (%)') }}",
                            data: trends.turnover,
                            backgroundColor: '#dc3545', // danger color
                            borderColor: '#dc3545',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
        }
    });
</script>

{% endblock %}

{% block content %}

<div class="row mb-4">
    <div class="col-md-12">
        <div class="card shadow-sm border-0">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <h2 class="mb-0"><i class="bi bi-people text-primary"></i> {{ lang('social_title') }}</h2>
                        <p class="text-muted mt-2 mb-0">{{ lang('social_desc') }}</p>
                    </div>
                    <div>
                        <a href="{{ url_for('social_export') }}" class="btn btn-sm btn-outline-success ms-2"><i class="bi bi-file-earmark-excel"></i> Excel Raporu</a>
                        <button class="btn btn-sm btn-outline-secondary ms-2" onclick="history.back()"><i class="bi bi-arrow-left"></i> {{ lang('btn_back', 'Geri') }}</button>
                    </div>
                </div>
                
                <!-- İstatistik Kartları Row 1 -->
                <div class="row mt-4">
                    <div class="col-md-4 mb-3">
                        <div class="card h-100 shadow-sm border-start border-4 border-primary">
                            <div class="card-body text-center">
                                <i class="bi bi-people-fill display-4 text-primary mb-3"></i>
                                <h5>{{ lang('social_employee_profile') }}</h5>
                                <h3 class="fw-bold">{{ stats.employees }}</h3>
                                <p class="text-muted small">{{ lang('social_total_employees') }}</p>
                                <button class="btn btn-sm btn-outline-primary w-100" data-bs-target="#addEmployeeModal" data-bs-toggle="modal" type="button">
                                    {{ lang('btn_add_data', 'Yeni Veri Girişi') }}
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="card h-100 shadow-sm border-start border-4 border-danger">
                            <div class="card-body text-center">
                                <i class="bi bi-heart-pulse-fill display-4 text-danger mb-3"></i>
                                <h5>{{ lang('social_ohs') }}</h5>
                                <h3 class="fw-bold">{{ stats.incidents }}</h3>
                                <p class="text-muted small">{{ lang('social_incidents') }}</p>
                                <button class="btn btn-sm btn-outline-danger w-100" data-bs-target="#addOHSModal" data-bs-toggle="modal" type="button">
                                    {{ lang('btn_add_data', 'Yeni Veri Girişi') }}
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="card h-100 shadow-sm border-start border-4 border-success">
                            <div class="card-body text-center">
                                <i class="bi bi-mortarboard-fill display-4 text-success mb-3"></i>
                                <h5>{{ lang('social_training') }}</h5>
                                <h3 class="fw-bold">{{ stats.training_hours | default(0) | round(1) }}</h3>
                                <p class="text-muted small">{{ lang('social_total_hours') }}</p>
                                <button class="btn btn-sm btn-outline-success w-100" data-bs-target="#addTrainingModal" data-bs-toggle="modal" type="button">
                                    {{ lang('btn_add_data', 'Yeni Veri Girişi') }}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- İstatistik Kartları Row 2 -->
                <div class="row mt-2">
                    <div class="col-md-6 mb-3">
                        <div class="card h-100 shadow-sm border-start border-4 border-info">
                            <div class="card-body text-center">
                                <i class="bi bi-emoji-smile-fill display-4 text-info mb-3"></i>
                                <h5>{{ lang('social_employee_satisfaction', 'Çalışan Memnuniyeti') }}</h5>
                                <h3 class="fw-bold">{{ stats.avg_satisfaction | default(0) }}</h3>
                                <p class="text-muted small">{{ lang('social_avg_score', 'Ortalama Skor') }}</p>
                                <button class="btn btn-sm btn-outline-info w-100" data-bs-target="#addSatisfactionModal" data-bs-toggle="modal" type="button">
                                    {{ lang('btn_add_data', 'Yeni Veri Girişi') }}
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="card h-100 shadow-sm border-start border-4 border-warning">
                            <div class="card-body text-center">
                                <i class="bi bi-cash-coin display-4 text-warning mb-3"></i>
                                <h5>{{ lang('social_community_investment', 'Topluluk Yatırımı') }}</h5>
                                <h3 class="fw-bold">{{ stats.total_investment | default(0) | round(0) }} TL</h3>
                                <p class="text-muted small">{{ lang('social_total_investment', 'Toplam Yatırım') }}</p>
                                <button class="btn btn-sm btn-outline-warning w-100" data-bs-target="#addInvestmentModal" data-bs-toggle="modal" type="button">
                                    {{ lang('btn_add_data', 'Yeni Veri Girişi') }}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Grafikler Row -->
                <div class="row mt-4">
                    <div class="col-md-6 mb-3">
                        <div class="card shadow-sm border-0 h-100">
                            <div class="card-header bg-white border-bottom-0">
                                <h5 class="mb-0"><i class="bi bi-graph-up-arrow text-info"></i> {{ lang('social_satisfaction_trend', 'Memnuniyet Trendi') }}</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="satisfactionChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="card shadow-sm border-0 h-100">
                            <div class="card-header bg-white border-bottom-0">
                                <h5 class="mb-0"><i class="bi bi-graph-down-arrow text-danger"></i> {{ lang('social_turnover_trend', 'Devir Hızı Trendi') }}</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="turnoverChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Son Kayıtlar Tablosu -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-light">
                                <h5 class="mb-0"><i class="bi bi-clock-history"></i> {{ lang('recent_activities') }}</h5>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>{{ lang('col_type') }}</th>
                                                <th>{{ lang('col_detail') }}</th>
                                                <th>{{ lang('col_date') }}</th>
                                                <th>{{ lang('col_value') }}</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for item in recent_data %}
                                            <tr>
                                                <td>
                                                    {% if item.type == 'employee' %}
                                            <span class="badge bg-primary">{{ lang('social_type_employee', 'Çalışan') }}</span>
                                            {% elif item.type == 'ohs' %}
                                            <span class="badge bg-danger">{{ lang('social_type_ohs', 'İSG') }}</span>
                                            {% elif item.type == 'training' %}
                                            <span class="badge bg-success">{{ lang('social_type_training', 'Eğitim') }}</span>
                                                    {% elif item.type == 'satisfaction' %}
                                                    <span class="badge bg-info">{{ lang('social_type_satisfaction', 'Memnuniyet') }}</span>
                                                    {% elif item.type == 'investment' %}
                                                    <span class="badge bg-warning text-dark">{{ lang('social_type_investment', 'Yatırım') }}</span>
                                                    {% endif %}
                                                </td>
                                                <td>{{ item.detail }}</td>
                                                <td>{{ item.date }}</td>
                                                <td>{{ item.value }}</td>
                                            </tr>
                                            {% else %}
                                            <tr>
                                                <td class="text-center text-muted py-3" colspan="4">{{ lang('no_data_yet') }}</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<!-- Modals -->

<!-- Çalışan Ekleme Modalı -->
<div class="modal fade" id="addEmployeeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ lang('add_new_employee', 'Yeni Çalışan Ekle') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('social_add') }}" method="POST">
                <div class="modal-body">
                    <input type="hidden" name="data_type" value="employee">
                    
                    <div class="mb-3">
                        <label class="form-label">{{ lang('full_name', 'Ad Soyad') }}</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">{{ lang('position', 'Pozisyon') }}</label>
                        <input type="text" class="form-control" name="position" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">{{ lang('department', 'Departman') }}</label>
                        <input type="text" class="form-control" name="department">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">{{ lang('gender', 'Cinsiyet') }}</label>
                        <select class="form-select" name="gender">
                            <option value="Male">{{ lang('male', 'Erkek') }}</option>
                            <option value="Female">{{ lang('female', 'Kadın') }}</option>
                            <option value="Other">{{ lang('other', 'Diğer') }}</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">{{ lang('start_date', 'Başlangıç Tarihi') }}</label>
                        <input type="date" class="form-control" name="start_date" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ lang('cancel', 'İptal') }}</button>
                    <button type="submit" class="btn btn-primary">{{ lang('save', 'Kaydet') }}</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Eğitim Ekleme Modalı -->
<div class="modal fade" id="addTrainingModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ lang('add_training_record', 'Eğitim Kaydı Ekle') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('social_add') }}" method="POST">
                <div class="modal-body">
                    <input type="hidden" name="data_type" value="training">
                    
                    <div class="mb-3">
                        <label class="form-label">{{ lang('training_name', 'Eğitim Adı') }}</label>
                        <input type="text" class="form-control" name="training_name" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">{{ lang('participants', 'Katılımcı Sayısı') }}</label>
                        <input type="number" class="form-control" name="participants" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">{{ lang('total_hours', 'Toplam Saat') }}</label>
                        <input type="number" step="0.1" class="form-control" name="total_hours" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">{{ lang('date', 'Tarih') }}</label>
                        <input type="date" class="form-control" name="date" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ lang('cancel', 'İptal') }}</button>
                    <button type="submit" class="btn btn-primary">{{ lang('save', 'Kaydet') }}</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- İSG Olayı Ekleme Modalı -->
<div class="modal fade" id="addIncidentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ lang('add_incident', 'İSG Olayı Ekle') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('social_add') }}" method="POST">
                <div class="modal-body">
                    <input type="hidden" name="data_type" value="incident">
                    
                    <div class="mb-3">
                        <label class="form-label">{{ lang('incident_type', 'Olay Tipi') }}</label>
                        <select class="form-select" name="incident_type" required>
                            <option value="Accident">{{ lang('accident', 'Kaza') }}</option>
                            <option value="Near Miss">{{ lang('near_miss', 'Ramak Kala') }}</option>
                            <option value="Hazard">{{ lang('hazard', 'Tehlike Bildirimi') }}</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">{{ lang('description', 'Açıklama') }}</label>
                        <textarea class="form-control" name="description" rows="3" required></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">{{ lang('severity', 'Ciddiyet') }}</label>
                        <select class="form-select" name="severity">
                            <option value="Low">{{ lang('low', 'Düşük') }}</option>
                            <option value="Medium">{{ lang('medium', 'Orta') }}</option>
                            <option value="High">{{ lang('high', 'Yüksek') }}</option>
                            <option value="Critical">{{ lang('critical', 'Kritik') }}</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">{{ lang('date', 'Tarih') }}</label>
                        <input type="date" class="form-control" name="date" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ lang('cancel', 'İptal') }}</button>
                    <button type="submit" class="btn btn-primary">{{ lang('save', 'Kaydet') }}</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Satisfaction Modal -->
<div class="modal fade" id="addSatisfactionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ lang('social_add_satisfaction', 'Çalışan Memnuniyeti Verisi Ekle') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('social_add') }}" method="POST">
                <div class="modal-body">
                    <input type="hidden" name="data_type" value="satisfaction">
                    <div class="mb-3">
                        <label class="form-label">{{ lang('col_year', 'Yıl') }}</label>
                        <input type="number" class="form-control" name="year" value="2024" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">{{ lang('survey_date', 'Anket Tarihi') }}</label>
                        <input type="date" class="form-control" name="survey_date" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">{{ lang('satisfaction_score', 'Memnuniyet Skoru (0-100)') }}</label>
                        <input type="number" class="form-control" name="satisfaction_score" step="0.1" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">{{ lang('turnover_rate', 'İş Gücü Devir Hızı (%)') }}</label>
                        <input type="number" class="form-control" name="turnover_rate" step="0.1" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">{{ lang('participation_rate', 'Katılım Oranı (%)') }}</label>
                        <input type="number" class="form-control" name="participation_rate" step="0.1">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">{{ lang('comments', 'Yorumlar') }}</label>
                        <textarea class="form-control" name="comments" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ lang('cancel', 'İptal') }}</button>
                    <button type="submit" class="btn btn-primary">{{ lang('save', 'Kaydet') }}</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Investment Modal -->
<div class="modal fade" id="addInvestmentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ lang('add_community_investment', 'Topluluk Yatırımı Ekle') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('social_add') }}" method="POST">
                <div class="modal-body">
                    <input type="hidden" name="data_type" value="investment">
                    <div class="mb-3">
                        <label class="form-label">{{ lang('project_name', 'Proje Adı') }}</label>
                        <input type="text" class="form-control" name="project_name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">{{ lang('investment_amount', 'Yatırım Tutarı (TL)') }}</label>
                        <input type="number" class="form-control" name="investment_amount" step="0.01" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">{{ lang('beneficiaries_count', 'Faydalanıcı Sayısı') }}</label>
                        <input type="number" class="form-control" name="beneficiaries_count">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">{{ lang('date', 'Tarih') }}</label>
                        <input type="date" class="form-control" name="date" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">{{ lang('impact_description', 'Etki Açıklaması') }}</label>
                        <textarea class="form-control" name="impact_description" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ lang('cancel', 'İptal') }}</button>
                    <button type="submit" class="btn btn-primary">{{ lang('save', 'Kaydet') }}</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}
